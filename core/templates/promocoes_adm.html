{% extends "base_adm.html" %}
{% block content %}

<style>
/* ================= ESTRUTURA E LAYOUT ================= */
.header-top {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px;
}
.promocoes-container {
    max-width: 1200px; margin: 40px auto; padding: 20px;
    font-family: 'Inter', sans-serif; color: #f3f4f6;
}
.grid-promocoes {
    display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:20px;
}

/* ================= CARDS ================= */
.card-promocao {
    background:#0b2545; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.4);
    overflow:hidden; transition:.3s;
}
.card-promocao:hover { transform:translateY(-4px); }
.card-promocao img { width:100%; height:180px; object-fit:cover; }
.card-body { padding:16px; display:flex; flex-direction: column; align-items: center; text-align: center; }
.card-body h3 { margin-bottom:6px; color:#e5e7eb; font-size:1.1rem; }
.card-body p { margin:4px 0; color:#94a3b8; font-size:0.9rem; }
.preco { font-size:1.2rem; font-weight:bold; color:#ffb703; margin:8px 0; }
.acoes { display:flex; gap:6px; width:100%; justify-content:center; }
.acoes a {
    display:inline-block; text-align:center; padding:6px 10px; border-radius:10px;
    color:white; font-weight:600; font-size:0.8rem;
}
.btn-editar { background:#3b82f6; }
.btn-excluir { background:#dc2626; }
.btn-novo {
    background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; padding: 10px 24px;
    border-radius: 12px; font-size: 0.9rem; font-weight: 700; border: none; cursor: pointer;
    transition: all 0.3s; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
    display: flex; align-items: center; gap: 8px;
}
.btn-novo:hover { transform: translateY(-3px) scale(1.02); }

/* ================= MODAL SYSTEM (BLINDADO) ================= */

/* Classe auxiliar para travar o body via JS */
body.modal-open {
    overflow: hidden !important;
    padding-right: 0 !important; /* Evita pulo de scroll */
}

/* 1. OVERLAY (Fundo Preto) */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(4px);
    z-index: 99990; /* Alta prioridade */

    /* ESTADO INICIAL: Invis√≠vel e INTOC√ÅVEL */
    opacity: 0;
    visibility: hidden;
    pointer-events: none; /* O SEGREDO: Clicks passam direto */

    transition: opacity 0.3s ease, visibility 0.3s ease;
}

/* 2. OVERLAY ATIVO */
.modal-overlay.active {
    opacity: 1;
    visibility: visible;
    pointer-events: auto; /* Agora bloqueia clicks */
}

/* 3. MODAL CARD */
.modal-card {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.95);
    z-index: 99999; /* Acima do overlay */
    background: #0b2545; border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px; padding: 30px; width: 90%; max-width: 550px;
    box-shadow: 0 30px 80px rgba(0,0,0,0.6);

    /* ESTADO INICIAL */
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);

    display: flex; flex-direction: column; max-height: 90vh; overflow-y: auto;
}

.modal-card.active {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transform: translate(-50%, -50%) scale(1);
}

/* Ajustes Espec√≠ficos Z-INDEX para o segundo modal */
#modalSeletorBrinquedo { z-index: 100001; }
#overlayBrinquedo { z-index: 100000; }

/* ================= FORMUL√ÅRIO E INPUTS ================= */
.modal-header { display:flex; justify-content: space-between; align-items:center; margin-bottom:20px; }
.btn-close {
    width:32px; height:32px; border-radius:50%; border:none; background:#1e3a8a;
    cursor:pointer; font-size:16px; color:#fff; transition:.2s;
}
.btn-close:hover { background:#3b82f6; }

.modal-card label { display:block; font-size:0.75rem; color:#94a3b8; text-transform:uppercase; margin-bottom:6px; text-align:center; }
.modal-card input:not([type="file"]), .modal-card select {
    width: 100%; margin-bottom: 15px; padding:12px; border-radius:12px;
    border:1px solid #334155; background:#1e293b; color:#fff; text-align:center;
}
.custom-file-upload {
    border: 2px dashed #334155; border-radius: 16px; padding: 20px; text-align: center;
    cursor: pointer; background: #1e293b; margin-bottom: 20px; display: block;
}
.custom-file-upload input { display: none; }
.modal-card button[type="submit"] {
    width:100%; padding:12px; border:none; border-radius:12px; background:#ffb703;
    color:#0b2545; font-weight:700; cursor:pointer; margin-top: 10px;
}

/* SELETOR DE BRINQUEDOS */
.grid-selecao-brinquedos {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 15px; max-height: 400px; overflow-y: auto; padding: 10px;
    background: #071426; border-radius: 12px;
}
.card-opcao-brinquedo {
    background: #1e3a8a; border-radius: 12px; padding: 8px; cursor: pointer;
    border: 3px solid transparent; text-align: center;
}
.card-opcao-brinquedo.selecionado { border-color: #ffb703; background: #2563eb; }
.card-opcao-brinquedo img { width: 100%; height: 100px; object-fit: cover; border-radius: 8px; }
.trigger-brinquedo {
    background: #1e3a8a; border: 1px solid #3b82f6; color: white; padding: 12px;
    border-radius: 12px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;
}
</style>

<div class="promocoes-container">
  <div class="header-top">
    <h1>üî• Promo√ß√µes</h1>
    <button class="btn-novo" onclick="abrirModalPrincipal('create')">‚ûï Nova Promo√ß√£o</button>
  </div>

  <div class="grid-promocoes">
    {% for promo in promocoes %}
    <div class="card-promocao">
      {% if promo.imagem_promocao %}
        <img src="{{ promo.imagem_promocao.url }}">
      {% endif %}
      <div class="card-body">
        <h3>{{ promo.descricao }}</h3>
        <p>üß∏ {{ promo.brinquedos.nome_brinquedo }}</p>
        <div class="preco">R$ {{ promo.preco_promocao|floatformat:2 }}</div>
        <div class="acoes">
          <a href="#" class="btn-editar" onclick="abrirModalPrincipal('update', {{ promo.id }})">‚úèÔ∏è Editar</a>
          <a href="#" class="btn-excluir" onclick="abrirModalPrincipal('delete', {{ promo.id }})">üóëÔ∏è Excluir</a>
        </div>
      </div>
    </div>
    {% empty %}
      <p>Nenhuma promo√ß√£o cadastrada.</p>
    {% endfor %}
  </div>
</div>

<div id="overlayPrincipal" class="modal-overlay"></div>
<div id="modalPromocao" class="modal-card">
  <div class="modal-header">
    <h3 id="modalTitulo">Nova Promo√ß√£o</h3>
    <button class="btn-close" onclick="fecharTudo()">‚úï</button>
  </div>
  <form id="modalForm" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <label>T√≠tulo da Oferta</label>
    <input type="text" name="descricao" id="descricao" placeholder="Ex: Queima de Estoque" required>

    <label>Imagem de Capa</label>
    <label for="imagem_promocao" class="custom-file-upload">
        <span id="file-chosen">üìÅ Clique para enviar imagem</span>
        <input type="file" name="imagem_promocao" id="imagem_promocao" onchange="updateFileName(this)">
    </label>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
            <label>Brinquedo Relacionado</label>
            <div class="trigger-brinquedo" onclick="abrirSeletor()">
                <span id="nomeBrinquedoEscolhido">Selecionar...</span>
            </div>
            <input type="hidden" name="brinquedos" id="brinquedo_id_hidden">
        </div>
        <div>
            <label>Pre√ßo Especial</label>
            <input type="number" step="0.01" name="preco_promocao" id="preco_promocao" placeholder="0,00">
        </div>
    </div>
    <button type="submit">Finalizar Promo√ß√£o</button>
  </form>
</div>

<div id="modalDelete" class="modal-card">
  <div class="modal-header">
    <h3>Confirmar exclus√£o</h3>
    <button class="btn-close" onclick="fecharTudo()">‚úï</button>
  </div>
  <p style="margin-bottom:15px;">Digite <b>EXCLUIR</b> para confirmar</p>
  <input type="text" id="confirmacaoDelete" placeholder="EXCLUIR">
  <button onclick="executarDelete()" class="btn-novo" style="width:100%; margin-top:10px; justify-content:center; background: #dc2626;">Confirmar Exclus√£o</button>
</div>

<div id="overlayBrinquedo" class="modal-overlay"></div>
<div id="modalSeletorBrinquedo" class="modal-card">
  <div class="modal-header">
    <h3>Escolha o Brinquedo</h3>
    <button class="btn-close" onclick="fecharSeletor()">‚úï</button>
  </div>
  <div class="grid-selecao-brinquedos">
    {% for b in brinquedos %}
    <div class="card-opcao-brinquedo" id="opt-{{ b.id }}" onclick="marcarBrinquedo('{{ b.id }}', '{{ b.nome_brinquedo }}')">
      {% if b.imagem_brinquedo %}
        <img src="{{ b.imagem_brinquedo.url }}">
      {% else %}
        <div style="height:100px; background:#071426; border-radius:8px; display:flex; align-items:center; justify-content:center;">üñºÔ∏è</div>
      {% endif %}
      <span>{{ b.nome_brinquedo }}</span>
    </div>
    {% endfor %}
  </div>
  <div style="display:flex; gap:10px; margin-top:20px;">
      <button class="btn-novo" style="flex:1; background:#10b981;" onclick="confirmarEscolha()">Confirmar</button>
      <button class="btn-novo" style="flex:1; background:#ef4444;" onclick="fecharSeletor()">Cancelar</button>
  </div>
</div>

<script>
let currentId = null;
let tempBrinquedoId = null;
let tempBrinquedoNome = null;

/* ================= GERENCIAMENTO DE MODAIS ================= */

function abrirModalPrincipal(action, id = null) {
    limparForm();
    const modalForm = document.getElementById('modalPromocao');
    const modalDel = document.getElementById('modalDelete');
    const overlay = document.getElementById('overlayPrincipal');

    document.body.classList.add('modal-open');
    overlay.classList.add('active');

    if (action === 'delete') {
        currentId = id;
        modalDel.classList.add('active');
    } else {
        modalForm.classList.add('active');

        // A URL agora √© sempre a mesma da view que criamos (PromocaoAdminView)
        document.getElementById("modalForm").action = "{% url 'promocoes_admin' %}";

        if (action === 'create') {
            document.getElementById("modalTitulo").innerText = "üî• Nova Promo√ß√£o";
            document.getElementById("promo_id_hidden_form").value = ""; // Vazio para criar
        } else {
            document.getElementById("modalTitulo").innerText = "‚úèÔ∏è Editar Promo√ß√£o";
            document.getElementById("promo_id_hidden_form").value = id; // Preenchido para editar

            // Opcional: Aqui voc√™ pode fazer um fetch para buscar os dados
            // da promo√ß√£o e preencher os campos do modal automaticamente.
        }
    }
}

function fecharTudo() {
    // 1. Remove classe ativa de TODOS os modais e overlays
    document.querySelectorAll('.modal-card, .modal-overlay').forEach(el => {
        el.classList.remove('active');
    });

    // 2. Destrava o Body
    document.body.classList.remove('modal-open');
}

/* ================= L√ìGICA DO SELETOR (N√çVEL 2) ================= */

function abrirSeletor() {
    // Abre o n√≠vel 2 sem fechar o n√≠vel 1
    document.getElementById('overlayBrinquedo').classList.add('active');
    document.getElementById('modalSeletorBrinquedo').classList.add('active');
}

function fecharSeletor() {
    // Fecha apenas o n√≠vel 2
    document.getElementById('overlayBrinquedo').classList.remove('active');
    document.getElementById('modalSeletorBrinquedo').classList.remove('active');
}

function marcarBrinquedo(id, nome) {
    document.querySelectorAll('.card-opcao-brinquedo').forEach(c => c.classList.remove('selecionado'));
    document.getElementById(`opt-${id}`).classList.add('selecionado');
    tempBrinquedoId = id;
    tempBrinquedoNome = nome;
}

function confirmarEscolha() {
    if(!tempBrinquedoId) { alert("Selecione um brinquedo!"); return; }
    document.getElementById("brinquedo_id_hidden").value = tempBrinquedoId;
    document.getElementById("nomeBrinquedoEscolhido").innerText = "üß∏ " + tempBrinquedoNome;
    fecharSeletor();
}

/* ================= UTILS ================= */

function updateFileName(input) {
    const label = document.getElementById('file-chosen');
    if (input.files && input.files.length > 0) {
        label.innerHTML = `<span>‚úÖ Selecionado:</span> ${input.files[0].name}`;
        label.style.color = "#10b981";
    }
}

function limparForm() {
    document.getElementById("modalForm").reset();
    document.getElementById("brinquedo_id_hidden").value = "";
    document.getElementById("nomeBrinquedoEscolhido").innerText = "Selecionar...";
    document.getElementById("file-chosen").innerText = "üìÅ Clique para enviar imagem";
    document.getElementById("file-chosen").style.color = "#94a3b8";
}

function executarDelete(){
  const valor = document.getElementById("confirmacaoDelete").value;
  if(valor !== "EXCLUIR") { alert("Digite EXCLUIR para confirmar"); return; }

  // Ajuste a URL para bater com o seu urls.py
  fetch(`/promocoes/${currentId}/delete/`, {
    method:'POST',
    headers: { "X-CSRFToken":"{{ csrf_token }}" },
  }).then(r=>r.json()).then(d=>{
    if(d.success) location.reload();
    else alert(d.error);
  });
}

// Fechamento ao clicar fora (Overlay)
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('overlayPrincipal').addEventListener('click', fecharTudo);
    document.getElementById('overlayBrinquedo').addEventListener('click', fecharSeletor);
});
</script>

{% endblock %}