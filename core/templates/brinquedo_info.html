{% extends "base.html" %}

{% block content %}


<style>

/* ======== BREADCRUMB ======== */
.breadcrumb {
    max-width: 1200px;
    margin: 25px auto;
    font-size: 1rem;
    color: #444;
}

.breadcrumb a {
    color: #007BFF;
    text-decoration: none;
    font-weight: 600;
}

.breadcrumb span {
    margin: 0 6px;
    color: #888;
}

.breadcrumb strong {
    color: #1f2d3d;
}

/* ======== CORRE√á√ÉO DO HOVER ======== */
.breadcrumb a:hover {
    color: #0056C9 !important;
    text-decoration: underline !important;
    transition: .25s ease !important;
}

/* ====== CONTAINER GERAL ====== */
.produto-container {
    max-width: 1100px;
    margin: 40px auto;
    padding: 30px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    background: #ffffff;
    border-radius: 22px;
    box-shadow: 0 10px 35px rgba(0,0,0,0.1);
    animation: fade .4s ease-in-out;
}

/* Fade de entrada */
@keyframes fade {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ====== IMAGEM ====== */
.produto-img img {
    width: 100%;
    border-radius: 22px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    transition: transform .3s ease;
}
.produto-img img:hover {
    transform: scale(1.02);
}

/* ====== T√çTULO ====== */
.produto-info h1 {
    font-size: 2.2rem;
    font-weight: 700;
    color: #222;
    margin-bottom: 12px;
}

/* ====== ESTRELAS ====== */
.avaliacao {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 12px 0 20px 0;
}

.stars {
    display: flex;
    gap: 3px;
}

.star {
    font-size: 1.4rem;
    color: #ffd200;
    animation: pop .3s ease;
}
@keyframes pop {
    from { transform: scale(0.5); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.nota-texto {
    font-size: 1rem;
    opacity: 0.8;
}

/* ====== PRE√áO ====== */
.preco {
    font-size: 2rem;
    font-weight: bold;
    color: #0cb52d;
    margin-bottom: 20px;
}

/* ====== T√çTULOS INTERNOS ====== */
.sec-titulo {
    font-size: 1.2rem;
    font-weight: 600;
    margin-top: 20px;
    margin-bottom: 6px;
    color: #333;
}

/* ====== TEXTO DESCRI√á√ÉO ====== */
.descricao-produto {
    font-size: 1.02rem;
    line-height: 1.7;
    color: #444;
    text-align: justify;
}

/* ====== BADGES ====== */
.categoria,
.tag {
    padding: 6px 12px;
    border-radius: 12px;
    display: inline-block;
    font-size: .85rem;
    margin: 4px;
    font-weight: 500;
}

.categoria {
    background: #dff0ff;
    color: #005e9c;
}

.tag {
    background: #f1f1f1;
    color: #555;
}

/* ===== BOT√ïES DO PRODUTO ===== */
.acoes-produto {
    margin-top: 20px;
    display: flex;
    justify-content: flex-end; /* empurra os bot√µes para a direita */
    gap: 12px;
    flex-wrap: wrap; /* caso quebre linha em telas pequenas */
}

.btn-produto {
    flex: 1; /* todos ocupam o mesmo espa√ßo */
    text-align: center;
    padding: 14px 6px;  /* gordinho mas n√£o largo */
    font-size: 0.95rem;
    font-weight: 700;
    border-radius: 14px;
    text-decoration: none;
    transition: .25s ease;
    white-space: nowrap;  /* impede quebrar linha */
}

/* Bot√£o azul ‚Äì Carrinho */
.btn-carrinho {
    background: #0d6efd;
    color: white;
    box-shadow: 0 4px 16px rgba(13,110,253,0.4);
}
.btn-carrinho:hover {
    background: #0056d6;
    transform: translateY(-2px);
}

/* Bot√£o verde ‚Äì Comprar */
.btn-comprar {
    background: #14a61a;
    color: white;
    box-shadow: 0 4px 16px rgba(20,166,26,0.4);
}
.btn-comprar:hover {
    background: #0e7f14;
    transform: translateY(-2px);
}

/* Bot√£o cinza ‚Äì Voltar */
.btn-voltar {
    background: #f1f1f1;
    color: #333;
    border: 1px solid #ddd;
}
.btn-voltar:hover {
    background: #e4e4e4;
    transform: translateY(-2px);
}


/* ===================== A√á√ïES DE OR√áAMENTO ===================== */

.acoes-orcamento {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
}

/* Base dos bot√µes */
.btn-acao {
    display: block;
    width: 100%;
    padding: 10px 0;
    border-radius: 22px;
    font-size: 0.95rem;
    font-weight: 600;
    text-align: center;
    text-decoration: none;
    transition: all .25s ease;
}

/* WhatsApp */
.btn-acao.whatsapp {
    background: linear-gradient(135deg, #25D366, #1ebe5d);
    color: #fff;
}

.btn-acao.whatsapp:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(37, 211, 102, 0.35);
}

/* Sob medida */
.btn-acao.sob-medida {
    background: linear-gradient(135deg, #FF9800, #FFB74D);
    color: #fff;
}

.btn-acao.sob-medida:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(255, 152, 0, 0.35);
}


.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.modal-box {
    background: #ffffff;
    width: 100%;
    max-width: 460px;
    border-radius: 18px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.25);
    animation: fadeIn .3s ease;
}

@keyframes fadeIn {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    padding: 18px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #004AAD;
}

.modal-close {
    font-size: 1.6rem;
    cursor: pointer;
}

.modal-body {
    padding: 20px;
}

.produto-nome {
    font-weight: 600;
    margin-bottom: 15px;
}

.medidas-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.medidas-grid label {
    font-size: 0.85rem;
    color: #555;
}

.medidas-grid input {
    width: 100%;
    padding: 8px;
    border-radius: 10px;
    border: 1px solid #ccc;
}

.resultado {
    margin-top: 20px;
    padding: 15px;
    background: #f1f6ff;
    border-radius: 14px;
    text-align: center;
}

.resultado strong {
    font-size: 1.5rem;
    color: #00913f;
}

.modal-footer {
    padding: 18px;
    display: flex;
    gap: 10px;
}

.btn-cancelar {
    flex: 1;
    background: #e0e0e0;
    border-radius: 25px;
    border: none;
    padding: 10px;
    cursor: pointer;
}

.btn-confirmar {
    flex: 1;
    background: linear-gradient(135deg, #004AAD, #0066D6);
    color: white;
    border-radius: 25px;
    border: none;
    padding: 10px;
    cursor: pointer;
}

.toast-carrinho {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: linear-gradient(135deg, #14a61a, #0e7f14);
    color: white;
    padding: 14px 24px;
    border-radius: 30px;
    font-weight: 600;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    opacity: 0;
    pointer-events: none;
    transition: all .35s ease;
    z-index: 99999;
}

.toast-carrinho.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

    .aviso-preco {
    font-family: 'Poppins', 'Segoe UI', sans-serif;
    font-size: 16px;
    font-weight: 500;
    color: #d97706; /* dourado elegante */
    background: #fff7ed;
    border-left: 4px solid #f59e0b;
    padding: 10px 14px;
    border-radius: 6px;
    margin-top: 8px;
}


@media (max-width: 768px) {

     .produto-img {
    text-align: center;
  }

  .produto-img img {
    max-width: 95%;
  }



  /* CONTAINER */
  .produto-container {
    margin: 20px 12px;
    padding: 18px;
    border-radius: 18px;
  }

  /* GRID ‚Üí COLUNA √öNICA */
  .combo-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }

  /* IMAGEM */
  .produto-img img {
    border-radius: 16px;
  }

  /* T√çTULOS */
  .combo-titulo,
  .combo-descricao {
    font-size: 1.6em;
    margin-bottom: 25px;
  }

  /* DESCRI√á√ÉO */
  .combo-descricao {
    line-height: 1.3;
  }

  /* LISTA DE BRINQUEDOS */
  .produto-info h3 {
    font-size: 1.1rem;
    margin-bottom: 10px;
  }

  .brinquedo-item {
    font-size: 0.95rem;
    padding: 10px;
  }

  /* PRE√áOS */
  .combo-precos {
    padding: 15px;
    border-radius: 15px;
  }

  .combo-precos p {
    font-size: 1rem;
    gap: 4px;
  }

  .preco-promo {
    font-size: 1.6rem;
  }

  /* BOT√ïES ‚Üí COLUNA */
  .combo-acoes {
    flex-direction: column;
    gap: 10px;
  }

  .btn-combo {
    width: 100%;
    font-size: 1rem;
    padding: 14px;
    border-radius: 14px;
  }

  /* TOAST */
  .toast-carrinho {
    bottom: 110px;
    width: 90%;
    text-align: center;
    font-size: 0.95rem;
  }
}


.quantidade-box {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 10px;
}

.qtd-input {
    width: 70px;
    text-align: center;
    font-size: 1rem;
    padding: 8px;
    border-radius: 10px;
    border: 1px solid #ddd;
    font-weight: 700;
}

.qtd-btn {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: none;
    background: #0d6efd;
    color: white;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: .2s;
}

.qtd-btn:hover {
    background: #0b5ed7;
}


</style>


<div class="breadcrumb" id="bread">
    <a href="/#brinquedos">Home</a>
    <span>‚Ä∫</span>
    <a href="{% url 'brinquedos' %}#bread">Todos os Brinquedos</a>
    <span>‚Ä∫</span>
    <strong>{{ brinquedo.nome_brinquedo }}</strong>
</div>



<div id="toast-carrinho" class="toast-carrinho">
    <span id="toast-msg"></span>
</div>


    <!-- ====== CONTE√öDO ====== -->
    <div class="produto-container" id="produto-box">

            <!-- IMAGEM -->
            <div class="produto-img">
            {% if brinquedo.imagem_brinquedo %}
                <img src="{{ brinquedo.imagem_brinquedo.url }}" alt="{{ brinquedo.nome_brinquedo }}">
            {% endif %}
        </div>
    <!-- INFORMA√á√ïES -->
    <div class="produto-info">

    <!-- T√çTULO -->
    <h1>{{ brinquedo.nome_brinquedo }}</h1>



    <!-- PRE√áO
    <p class="preco js-preco"
       data-valor="{{ brinquedo.valor_brinquedo }}">
       R$ 0,00
    </p>
        -->

    <p class="preco aviso-preco">
        Confira o pre√ßo com o fornecedor
    </p>


    <!-- DESCRI√á√ÉO -->
    <p class="sec-titulo">Descri√ß√£o do Produto</p>
    <p class="descricao-produto">
        {{ brinquedo.descricao }}
    </p>

       <!-- AVALIA√á√ÉO COM ESTRELAS -->
    <div class="avaliacao" data-rating="{{ brinquedo.avaliacao }}">
        <div class="stars" id="estrelinhas"></div>
        <span class="nota-texto">{{ brinquedo.avaliacao|floatformat:2 }}/5</span>
    </div>


    <!-- VOLTAGEM -->
    <p class="sec-titulo">Voltagem</p>
    <p>{{ brinquedo.voltz }}</p>

    <!-- CATEGORIAS -->
    <p class="sec-titulo">Categorias</p>
    {% for cat in brinquedo.categorias_brinquedos.all %}
        <span class="categoria">{{ cat.nome_categoria }}</span>
    {% endfor %}

    <!-- TAGS -->
    <p class="sec-titulo">Tags</p>
    {% for tag in brinquedo.tags.all %}
        <span class="tag">#{{ tag.nome_tags }}</span>
    {% endfor %}

        <!-- ===== QUANTIDADE =====

<div class="quantidade-box">
                <button type="button" class="qtd-btn" onclick="alterarQtd(-1)">‚àí</button>

                <input type="number"
                       id="quantidade-input"
                       value="1"
                       min="1"
                       class="qtd-input">

                <button type="button" class="qtd-btn" onclick="alterarQtd(1)">+</button>
            </div>


 -->
    <!-- BOT√ïES DE A√á√ÉO -->
    <div class="acoes-produto">
   <!--


            <button type="button"
                    class="btn-produto btn-carrinho"
                    onclick="adicionarAoCarrinho('brinquedo', {{ brinquedo.id }})">
                üõí Adicionar ao Carrinho
            </button>


        <a href="#" class="btn-produto btn-comprar">‚ö° Comprar Agora</a>

-->
            <!-- WhatsApp -->
                <a
                    href="https://wa.me/5511960563135?text=
            Ol√°! üëã%0A
            Gostaria de um or√ßamento para o brinquedo abaixo:%0A%0A
            üß∏ Nome: {{ brinquedo.nome_brinquedo|urlencode }}%0A
            ‚≠ê Avalia√ß√£o: {{ brinquedo.avaliacao|floatformat:2 }}/5%0A
            ‚ö° Voltagem: {{ brinquedo.voltz|urlencode }}%0A%0A
            üìê Dimens√µes:%0A
            ‚ÜïÔ∏è Altura: {{ brinquedo.altura_m }} m%0A
            ‚ÜîÔ∏è Largura: {{ brinquedo.largura_m }} m%0A
            ‚ÜóÔ∏è Profundidade: {{ brinquedo.profundidade_m }} m%0A
            üì¶ Volume: {{ brinquedo.volume_formatado|urlencode }}%0A%0A
            üîó P√°gina do produto:%0A
            {{ request.build_absolute_uri|urlencode }}%0A%0A
            Fico no aguardo üòä"
                    target="_blank"
                    class="btn-acao whatsapp"
                >
                    <i class="fab fa-whatsapp"></i> Or√ßamento via WhatsApp
                </a>

        {% if brinquedo.nome_categoria == "brinquedao" or brinquedo.nome_categoria == "trampolins" or brinquedo.nome_categoria == "trampolim" %}
            <button class="btn-acao sob-medida"
                onclick="abrirModalSobMedida(this)"
                data-id="{{ brinquedo.id }}"
                data-nome="{{ brinquedo.nome_brinquedo }}"
                data-valor="{{ brinquedo.valor_brinquedo }}"
                data-altura="{{ brinquedo.altura_m }}"
                data-largura="{{ brinquedo.largura_m }}"
                data-profundidade="{{ brinquedo.profundidade_m }}">
            üìê Or√ßamento sob medida
        </button>
        {% endif %}


        <a href="/#brinquedos" class="btn-produto btn-voltar">‚Üê Voltar</a>
    </div>

</div>

</div>  <!--fecha produto-container -->


<div id="modalSobMedida" class="modal-overlay">
    <div class="modal-box">

        <div class="modal-header">
            <h2>üìê Or√ßamento sob medida</h2>
            <span class="modal-close" onclick="fecharModal()">√ó</span>
        </div>

        <div class="modal-body">
            <p class="produto-nome"></p>

            <div class="medidas-grid">
                <div>
                    <label>Altura (m)</label>
                    <input type="text" step="0.1" id="alturaInput">
                </div>

                <div>
                    <label>Largura (m)</label>
                    <input type="text" step="0.1" id="larguraInput">
                </div>

                <div>
                    <label>Profundidade (m)</label>
                    <input type="text" step="0.1" id="profundidadeInput">
                </div>
            </div>

            <div class="resultado">
                <span>Novo valor estimado</span>
                <strong id="valorCalculado">R$ 0,00</strong>
            </div>
        </div>

        <div class="modal-footer">
    <button class="btn-cancelar" onclick="fecharModal()">Cancelar</button>

    <form method="post"
          action="{% url 'adicionar_ao_carrinho' 'brinquedo' brinquedo.id %}"
          style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn-produto btn-carrinho">
            üõí Adicionar ao Carrinho
        </button>
    </form>
</div>

    </div>
</div>


<!-- ====== JS DAS ESTRELAS ====== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const rating = parseFloat("{{ brinquedo.avaliacao }}");
    const container = document.getElementById("estrelinhas");

    let stars = "";

    for (let i = 1; i <= 5; i++) {
        if (rating >= i) {
            stars += `<span class="star">‚≠ê</span>`;
        } else if (rating >= i - 0.5) {
            stars += `<span class="star">‚ú®</span>`;
        } else {
            stars += `<span class="star" style="opacity:0.25">‚≠ê</span>`;
        }
    }

    container.innerHTML = stars;
});


let produtoAtual = {};

function normalizarNumero(valor, fallback = 1) {
    const n = parseFloat(valor);
    return isNaN(n) || n <= 0 ? fallback : n;
}

function abrirModalSobMedida(btn) {
    produtoAtual = {
        id: btn.dataset.id,
        nome: btn.dataset.nome,
        valor: normalizarNumero(btn.dataset.valor, 0),
        altura: normalizarNumero(btn.dataset.altura),
        largura: normalizarNumero(btn.dataset.largura),
        profundidade: normalizarNumero(btn.dataset.profundidade)
    };

    document.querySelector('.produto-nome').innerText = produtoAtual.nome;

    alturaInput.value = produtoAtual.altura.toFixed(2).replace('.', ',');
    larguraInput.value = produtoAtual.largura.toFixed(2).replace('.', ',');
    profundidadeInput.value = produtoAtual.profundidade.toFixed(2).replace('.', ',');

    calcularValor();
    document.getElementById('modalSobMedida').style.display = 'flex';
}

function fecharModal() {
    document.getElementById('modalSobMedida').style.display = 'none';
}

['alturaInput','larguraInput','profundidadeInput'].forEach(id => {
    document.getElementById(id).addEventListener('input', calcularValor);
});

function calcularValor() {
    const a = parseDecimalBR(alturaInput.value);
    const l = parseDecimalBR(larguraInput.value);
    const p = parseDecimalBR(profundidadeInput.value);

    if (a <= 0 || l <= 0 || p <= 0 || produtoAtual.valor <= 0) {
        valorCalculado.innerText = 'R$ 0,00';
        return;
    }

    const volumePadrao =
        produtoAtual.altura *
        produtoAtual.largura *
        produtoAtual.profundidade;

    if (volumePadrao <= 0) {
        valorCalculado.innerText = 'R$ 0,00';
        return;
    }

    const volumeNovo = a * l * p;
    const precoPorM3 = produtoAtual.valor / volumePadrao;
    const novoValor = volumeNovo * precoPorM3;

    valorCalculado.innerText =
        'R$ ' + novoValor.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
}

function adicionarSobMedida() {
    // Aqui voc√™ envia via fetch para criar ItemCarrinho customizado
    alert('Produto sob medida adicionado (implementar backend)');
    fecharModal();
}

function formatarDecimalBR(valor) {
    // Remove tudo que n√£o for n√∫mero
    valor = valor.replace(/\D/g, '');

    if (!valor) return '0,00';

    // Garante pelo menos 2 casas decimais
    while (valor.length < 3) {
        valor = '0' + valor;
    }

    const inteiro = valor.slice(0, -2);
    const decimal = valor.slice(-2);

    return inteiro.replace(/^0+/, '') + ',' + decimal;
}

function parseDecimalBR(valor) {
    if (!valor) return 0;
    return parseFloat(valor.replace('.', '').replace(',', '.')) || 0;
}


['alturaInput', 'larguraInput', 'profundidadeInput'].forEach(id => {
    const input = document.getElementById(id);

    input.addEventListener('input', () => {
        const pos = input.selectionStart;
        input.value = formatarDecimalBR(input.value);
        input.setSelectionRange(pos, pos);
        calcularValor();
    });
});

function formatarMoedaBR(valor) {
    if (!valor || isNaN(valor)) return '0,00';

    return Number(valor).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.js-preco').forEach(el => {
        const valor = parseFloat(el.dataset.valor);
        el.innerText = 'R$ ' + formatarMoedaBR(valor);
    });
});


function adicionarAoCarrinho(tipo, id) {
    fetch(`/carrinho/adicionar/${tipo}/${id}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(res => {
        if (!res.ok) throw new Error('HTTP error');
        return res.json();
    })
    .then(data => {
        if (data.sucesso) {
            mostrarToast('üõí Produto adicionado ao carrinho!');

            // Atualiza o n√∫mero do carrinho usando o total do backend
            if (data.total_itens !== undefined) {
                atualizarBadgeCarrinho(data.total_itens);
            }
        } else {
            mostrarToast(data.erro || 'Erro ao adicionar', true);
        }
    })
    .catch(() => {
        mostrarToast('Erro ao adicionar ao carrinho', true);
    });
}


function mostrarToast(msg, erro = false) {
    const toast = document.getElementById('toast-carrinho');
    const texto = document.getElementById('toast-msg');

    texto.innerText = msg;
    toast.style.background = erro
        ? 'linear-gradient(135deg, #dc3545, #a71d2a)'
        : 'linear-gradient(135deg, #14a61a, #0e7f14)';

    toast.classList.add('show');

    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}


function atualizarBadgeCarrinho(total) {
    const badge = document.getElementById('badge-carrinho');
    const carrinho = document.getElementById('float-carrinho');

    if (!badge || !carrinho) return;

    badge.innerText = total;

    // efeito pulse
    badge.classList.remove('pulse');
    void badge.offsetWidth;
    badge.classList.add('pulse');

    carrinho.style.display = 'flex';
}

function alterarQtd(delta) {
    const input = document.getElementById('quantidade-input');
    let valor = parseInt(input.value) || 1;

    valor += delta;
    if (valor < 1) valor = 1;

    input.value = valor;
}

</script>

{% endblock %}