{% extends "base_adm.html" %}
{% block content %}

<style>
/* ===== CONTAINER ===== */
.eventos-container {
    max-width:1200px;
    margin:40px auto;
    padding:20px;
}

.header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:30px;
}

.btn-novo {
    background:linear-gradient(135deg,#0d6efd,#0a58ca);
    color:#fff;
    padding:14px 22px;
    border-radius:18px;
    font-weight:700;
    border:none;
    cursor:pointer;
}

/* ===== GRID ===== */
/* GRID MAIS EST√ÅVEL */
.grid-eventos {
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
    gap:30px;
    align-items:center;
}

/* CARD BASE */
.evento-card {
    background:#fff;
    border-radius:24px;
    box-shadow:0 12px 30px rgba(0,0,0,.12);
    display:flex;
    flex-direction:column;
    overflow:hidden;
    height:100%; /* üîë mesma altura */
    min-height:520px; /* üî• padr√£o visual */
}

/* IMAGEM PADR√ÉO */
.evento-img {
    width:100%;
    height:180px;
    overflow:hidden;
    background:#e2e8f0;
}

.evento-img img {
    width:100%;
    height:100%;
    object-fit:cover;
}

/* CONTE√öDO */
.evento-conteudo {
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:10px;
    flex-grow:1; /* üîë empurra bot√µes pra baixo */
}

.evento-conteudo h3 {
    font-size:1.2rem;
    font-weight:800;
    color:#0f172a;
    min-height:48px; /* üî• t√≠tulos alinhados */
}

.evento-conteudo p {
    font-size:.95rem;
    color:#475569;
    line-height:1.5;
    flex-grow:1;
}

/* A√á√ïES SEMPRE NO FUNDO */
.evento-acoes {
    padding:16px 20px 20px;
    display:flex;
    gap:10px;
    margin-top:auto;
}

.evento-acoes button {
    flex:1;
    padding:12px;
    border-radius:14px;
    border:none;
    font-weight:800;
    cursor:pointer;
}

/* BOT√ïES */
.btn-editar {
    background:#facc15;
}

.btn-excluir {
    background:#dc3545;
    color:white;
}


/* ===== MODAL ===== */
/* ===== MODAL BACKDROP ===== */
.modal {
    position:fixed;
    inset:0;
    background:rgba(15,23,42,.55);
    backdrop-filter:blur(6px);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
    padding:16px; /* evita colar nas bordas no mobile */
}

/* ===== MODAL CARD ===== */
.modal-card {
    background:#ffffff;
    width:100%;
    max-width:760px;
    max-height:90vh;              /* üî• limite de altura */
    border-radius:20px;
    box-shadow:0 40px 80px rgba(0,0,0,.25);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    animation:scaleIn .25s ease;
}
.modal-body {
    padding:26px;
    overflow-y:auto;        /* üî• scroll interno */
    max-height:calc(90vh - 140px);
}

/* ===== HEADER ===== */
.modal-header {
    padding:22px 26px;
    border-bottom:1px solid #eef1f6;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.modal-header h2 {
    font-size:1.4rem;
    font-weight:800;
    color:#0f172a;
}

.modal-close {
    background:#f1f5f9;
    border:none;
    width:38px;
    height:38px;
    border-radius:12px;
    cursor:pointer;
    font-size:18px;
}

/* ===== BODY ===== */
.modal-body {
    padding:26px;
}

.modal-body p {
    color:#475569;
    font-size:.95rem;
    line-height:1.5;
}

/* ===== FORM ===== */
.modal-body form {
    display:flex;
    flex-direction:column;
    gap:14px;
}

.modal-body input,
.modal-body textarea,
.modal-body select {
    width:100%;
    padding:14px 16px;
    border-radius:14px;
    border:1px solid #e2e8f0;
    font-size:.95rem;
    outline:none;
}

.modal-body input:focus,
.modal-body textarea:focus,
.modal-body select:focus {
    border-color:#0d6efd;
}

/* ===== FOOTER ===== */
.modal-footer {
    padding:20px 26px;
    border-top:1px solid #eef1f6;
    display:flex;
    gap:12px;
    justify-content:flex-end;
}

/* ===== BUTTONS ===== */
.btn-primary {
    background:linear-gradient(135deg,#0d6efd,#0a58ca);
    color:white;
    padding:14px 22px;
    border-radius:16px;
    font-weight:700;
    border:none;
    cursor:pointer;
}

.btn-danger {
    background:linear-gradient(135deg,#dc3545,#b02a37);
    color:white;
    padding:14px 22px;
    border-radius:16px;
    font-weight:700;
    border:none;
    cursor:pointer;
}

.btn-ghost {
    background:#f1f5f9;
    padding:14px 22px;
    border-radius:16px;
    border:none;
    font-weight:700;
    cursor:pointer;
}

/* ===== ANIMATIONS ===== */
@keyframes fadeIn {
    from { opacity:0 }
    to { opacity:1 }
}

@keyframes scaleIn {
    from { transform:scale(.92); opacity:0 }
    to { transform:scale(1); opacity:1 }
}

    /* ===== MODAL LARGE ===== */
.modal-lg {
    max-width:760px;
    border-radius:18px;
}

/* ===== FORM SECTIONS ===== */
.form-section {
    margin-bottom:28px;
}

.form-section h4 {
    font-size:1.05rem;
    margin-bottom:12px;
    color:#0f172a;
}

/* ===== UPLOAD BOX ===== */
.upload-box {
    border:2px dashed #cbd5e1;
    border-radius:16px;
    padding:28px;
    text-align:center;
    cursor:pointer;
    color:#64748b;
    font-weight:600;
    transition:.25s;
    display:block;
}

.upload-box:hover {
    border-color:#0d6efd;
    background:#f8fafc;
}

.upload-box input {
    display:none;
}

/* ===== PREVIEW GRID ===== */
.preview-grid {
    margin-top:16px;
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(110px,1fr));
    gap:14px;
}

.preview-item {
    position:relative;
    border-radius:14px;
    overflow:hidden;
    box-shadow:0 8px 18px rgba(0,0,0,.15);
}

.preview-item img {
    width:100%;
    height:110px;
    object-fit:cover;
    display:block;
}

/* REMOVE ICON */
.preview-item button {
    position:absolute;
    top:6px;
    right:6px;
    background:rgba(0,0,0,.65);
    border:none;
    color:white;
    width:26px;
    height:26px;
    border-radius:50%;
    cursor:pointer;
}
@media (max-width: 640px) {

    .modal-card {
        max-width:100%;
        max-height:100vh;
        border-radius:18px;
    }

    .modal-header {
        padding:18px 20px;
    }

    .modal-body {
    display:flex;
    flex-direction:column;
    align-items:stretch;
}

    .modal-footer {
        flex-direction:column;
    }

    .modal-footer button {
        width:100%;
    }

    .preview-grid {
        grid-template-columns:repeat(3, 1fr);
    }
}

    @media (min-width: 1200px) {
    .modal-card {
        max-width:820px;
    }
}


@media (min-width: 768px) {
    .modal-body {
        padding-left:34px;
        padding-right:34px;
    }
}

/* ===== FIELD GROUP ===== */
.field-group {
    display:flex;
    flex-direction:column;
    gap:6px;
}

/* ===== LABEL ===== */
.field-group label {
    font-size:.85rem;
    font-weight:700;
    color:#334155;
}

/* ===== AJUSTE INPUTS ===== */
.field-group input,
.field-group textarea,
.field-group select {
    background:#f8fafc;
}

.field-group textarea {
    min-height:70px;   /* üîΩ menor altura */
    max-height:120px;
    resize:vertical;
}

/* ===== CENTRALIZA√á√ÉO VISUAL DO MODAL ===== */
.modal-card {
    align-self:center;
}

/* ===== FORM MAIS ORGANIZADO ===== */
.modal-body form {
    gap:22px;
}

/* ===== BRINQUEDOS GRID ===== */
.brinquedos-grid {
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));
    gap:16px;
    margin-top:12px;
}

.brinquedo-card {
    background:#fff;
    border-radius:16px;
    box-shadow:0 8px 20px rgba(0,0,0,.12);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    transition:.25s;
}

.brinquedo-card:hover {
    transform:translateY(-4px);
}

.brinquedo-card img {
    width:100%;
    height:110px;
    object-fit:cover;
}

.brinquedo-info {
    padding:12px;
    text-align:center;
    display:flex;
    flex-direction:column;
    gap:8px;
}

.brinquedo-info span {
    font-size:.9rem;
    font-weight:700;
    color:#0f172a;
}

.brinquedo-info button {
    background:#0d6efd;
    color:#fff;
    border:none;
    padding:8px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
    transition:.2s;
}

.brinquedo-info button.remover {
    background:#dc3545;
}

/* ===== BRINQUEDO SELECIONADO ===== */
.brinquedo-card.selecionado {
    border:2px solid #0d6efd;
    box-shadow:0 0 0 3px rgba(13,110,253,.25),
               0 12px 26px rgba(0,0,0,.2);
    transform:scale(1.02);
}

.brinquedo-card.selecionado::after {
    content:"‚úî Selecionado";
    position:absolute;
    top:8px;
    left:8px;
    background:#0d6efd;
    color:#fff;
    font-size:.7rem;
    font-weight:800;
    padding:4px 8px;
    border-radius:10px;
}


    /* ===== CAROUSEL ===== */
.evento-carousel {
    position:relative;
    width:100%;
    height:260px; /* üî• maior */
    overflow:hidden;
    background:#0f172a; /* fundo escuro elegante */
    display:flex;
    align-items:center;
    justify-content:center;
}

.carousel-img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover; /* Mude para cover se quiser preencher o card todo */
    background: #0f172a;
    opacity: 0; /* Come√ßam invis√≠veis */
    transition: opacity .4s ease;
}

.carousel-img.active {
    opacity: 1; /* Apenas a ativa aparece */
    z-index: 1;
}

/* BOT√ïES */
.carousel-btn {
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    background:rgba(0,0,0,.55);
    color:#fff;
    border:none;
    width:34px;
    height:34px;
    border-radius:50%;
    cursor:pointer;
    font-size:20px;
    font-weight:800;
}

.carousel-btn.prev { left:10px; }
.carousel-btn.next { right:10px; }


    #confirmDeleteInput {
    text-transform:uppercase;
    font-weight:700;
    letter-spacing:1px;
}

#btnConfirmDelete:disabled {
    opacity:.45;
    cursor:not-allowed;
}


    /* Campo de descri√ß√£o menor */
    textarea[name="descricao"] {
        min-height: 80px !important;
        height: 100px;
        resize: vertical;
    }

    /* Modal sobreposto (Z-Index maior) */
    #modalBrinquedo {
        z-index: 10001;
        background: rgba(0,0,0,0.4); /* Backdrop mais escuro para o segundo modal */
    }

    .modal-card.small {
        max-width: 450px;
    }

</style>
<div class="eventos-container">

    <div class="header">
        <h1>üéâ Eventos</h1>
        <button class="btn-novo" onclick="openCreate()">‚ûï Novo Evento</button>
    </div>

    <div class="grid-eventos">
    {% for evento in eventos %}
    <div class="evento-card">

{% if evento.imagens_list %}
<div class="evento-carousel" data-index="0">
    {% for img_url in evento.imagens_list %}
        <img
            src="{{ img_url }}"
            alt="{{ evento.titulo }}"
            loading="lazy"
            class="carousel-img {% if forloop.first %}active{% endif %}">
    {% endfor %}

    {% if evento.imagens_list|length > 1 %}
        <button class="carousel-btn prev" onclick="carouselPrev(this)">‚Äπ</button>
        <button class="carousel-btn next" onclick="carouselNext(this)">‚Ä∫</button>
    {% endif %}
</div>
{% else %}
<div class="evento-img">
    <img src="/static/images/IMAG1.PNG" alt="Sem imagem">
</div>
{% endif %}


        <div class="evento-conteudo">
            <h3>{{ evento.titulo }}</h3>
            <p>{{ evento.descricao|truncatechars:120 }}</p>
        </div>

        <div class="evento-acoes">
            <button class="btn-editar"
                onclick='openEdit(
                    {{ evento.id }},
                    "{{ evento.titulo|escapejs }}",
                    "{{ evento.descricao|escapejs }}",
                    {{ evento.brinquedos|safe }}
                )'>
                ‚úèÔ∏è Editar
            </button>

            <button class="btn-excluir"
                onclick="openDelete({{ evento.id }})">
                üóëÔ∏è Excluir
            </button>
        </div>

    </div>
    {% endfor %}
</div>

</div>


<!-- MODAL FORM -->
<div id="modalForm" class="modal">
    <div class="modal-card modal-lg">

        <div class="modal-header">
            <h2 id="modalTitle">Novo Evento</h2>
            <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>

        <div class="modal-body">

            <form id="eventoForm" enctype="multipart/form-data">
                {% csrf_token %}

                <input type="hidden" name="id" id="eventoId">
                <input type="hidden" name="action" id="eventoAction">

                <!-- DADOS B√ÅSICOS -->
                <div class="form-section">
                    <h4>üìå Informa√ß√µes do Evento</h4>

                    <div class="field-group">
                        <label for="id_titulo">T√≠tulo do Evento</label>
                        {{ form.titulo }}
                    </div>

                    <div class="field-group">
                        <label for="id_descricao">Descri√ß√£o</label>
                        {{ form.descricao }}
                    </div>

                    <div class="field-group">
                        <label>Brinquedos dispon√≠veis</label>

                        <!-- BRINQUEDOS SELECIONADOS -->
                        <div id="brinquedosInputs"></div>

                        <div class="brinquedos-grid">
                            {% for brinquedo in brinquedos %}
                            <div class="brinquedo-card" data-id="{{ brinquedo.id }}">
                                <img src="{{ brinquedo.imagem_brinquedo.url }}">
                                <div class="brinquedo-info">
                                    <span>{{ brinquedo.nome_brinquedo }}</span>
                                    <button type="button"
                                            onclick="toggleBrinquedo({{ brinquedo.id }}, this)">
                                        Selecionar
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- IMAGENS -->
                <div class="form-section">
                    <h4>üñºÔ∏è Imagens do Evento</h4>

                    <label class="upload-box">
                        <input type="file"
                               name="imagens"
                               multiple
                               accept="image/*"
                               onchange="previewImages(this)">
                        <span>üì§ Clique ou arraste imagens aqui</span>
                    </label>

                    <div id="previewGrid" class="preview-grid"></div>
                </div>

                <div class="modal-footer">
                    <button type="button"
                            class="btn-ghost"
                            onclick="closeModal()">
                        Cancelar
                    </button>

                    <button class="btn-primary">
                        üíæ Salvar Evento
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>


<!-- MODAL DELETE -->
<div id="modalDelete" class="modal">
    <div class="modal-card">

        <div class="modal-header">
            <h2>Excluir Evento</h2>
            <button class="modal-close"
                    onclick="modalDelete.style.display='none'">
                ‚úï
            </button>
        </div>

        <div class="modal-body">
    <p>
        Para confirmar a exclus√£o deste evento, digite
        <strong>EXCLUIR</strong> abaixo.
        <br>
        <strong>Essa a√ß√£o n√£o poder√° ser desfeita.</strong>
    </p>

    <form id="deleteForm">
        {% csrf_token %}

        <input type="hidden" name="id" id="deleteId">
        <input type="hidden" name="action" value="delete">

        <div class="field-group">
            <label>Digite EXCLUIR para confirmar</label>
            <input type="text"
                   id="confirmDeleteInput"
                   placeholder="EXCLUIR"
                   autocomplete="off">
        </div>

        <div class="modal-footer">
            <button type="button"
                    class="btn-ghost"
                    onclick="modalDelete.style.display='none'">
                Cancelar
            </button>

            <button class="btn-danger"
                    id="btnConfirmDelete"
                    disabled>
                üóëÔ∏è Excluir
            </button>
        </div>
    </form>
</div>

    </div>
</div>

<div id="modalDetalhes" class="modal">
    <div class="modal-card modal-lg">

        <div class="modal-header">
            <h2 id="detalhesTitulo"></h2>
            <button class="modal-close"
                    onclick="modalDetalhes.style.display='none'">‚úï</button>
        </div>

        <div class="modal-body">
            <p id="detalhesDescricao"></p>

            <h4 style="margin-top:20px">üß∏ Brinquedos</h4>
            <ul id="detalhesBrinquedos"></ul>
        </div>

    </div>
</div>




<script>
function openCreate(){
    // Verifique se os IDs existem no HTML (modalForm, modalTitle, etc)
    document.getElementById("modalForm").style.display="flex";
    document.getElementById("modalTitle").innerText="Novo Evento";
    document.getElementById("eventoAction").value="create";
    document.getElementById("eventoId").value="";
}

function openEdit(id, titulo, descricao, brinquedosSelecionados){
    modalForm.style.display="flex";
    modalTitle.innerText="Editar Evento";
    eventoAction.value="update";
    eventoId.value=id;

    id_titulo.value = titulo;
    id_descricao.value = descricao;

    document.getElementById("brinquedosInputs").innerHTML = "";

    document.querySelectorAll(".brinquedo-card").forEach(card=>{
        card.classList.remove("selecionado");
        card.querySelector("button").innerText = "Selecionar";
        card.querySelector("button").classList.remove("remover");
    });

    brinquedosSelecionados.forEach(id=>{
        const card = document.querySelector(`.brinquedo-card[data-id="${id}"]`);
        if(!card) return;

        const btn = card.querySelector("button");
        toggleBrinquedo(id, btn);
    });
}

function openDelete(id){
    modalDelete.style.display="flex";
    deleteId.value=id;

    // reset
    confirmDeleteInput.value = "";
    btnConfirmDelete.disabled = true;
}

document.querySelectorAll("form").forEach(form=>{
    form.addEventListener("submit",e=>{
        e.preventDefault();
        fetch("{% url 'eventos_admin' %}",{
            method:"POST",
            body:new FormData(form),
            headers:{"X-Requested-With":"XMLHttpRequest"}
        }).then(r=>r.json()).then(data=>{
            if(data.success) location.reload();
        });
    });
});

window.onclick = e=>{
    if(e.target.classList.contains("modal")) e.target.style.display="none";
};


   let selectedFiles = [];

function previewImages(input) {
    const preview = document.getElementById("previewGrid");
    const files = Array.from(input.files);

    for (let file of files) {
        if (selectedFiles.length >= 5) {
            alert("‚ö†Ô∏è Voc√™ pode selecionar no m√°ximo 5 imagens.");
            break;
        }

        selectedFiles.push(file);
    }

    renderPreview();
    syncInputFiles(input);
}

function renderPreview() {
    const preview = document.getElementById("previewGrid");
    preview.innerHTML = "";

    selectedFiles.forEach((file, index) => {
        const reader = new FileReader();

        reader.onload = e => {
            const div = document.createElement("div");
            div.className = "preview-item";
            div.innerHTML = `
                <img src="${e.target.result}">
                <button type="button" onclick="removeImage(${index})">‚úï</button>
            `;
            preview.appendChild(div);
        };

        reader.readAsDataURL(file);
    });
}

function removeImage(index) {
    selectedFiles.splice(index, 1);
    syncInputFiles(document.querySelector('input[type="file"]'));
    renderPreview();
}

function syncInputFiles(input) {
    const dataTransfer = new DataTransfer();
    selectedFiles.forEach(file => dataTransfer.items.add(file));
    input.files = dataTransfer.files;
}

function closeModal() {
    document.getElementById("modalForm").style.display = "none";
}


function toggleBrinquedo(id, btn) {
    const card = btn.closest(".brinquedo-card");
    const container = document.getElementById("brinquedosInputs");

    const inputId = `brinquedo_${id}`;
    let hidden = document.getElementById(inputId);

    if (hidden) {
        // remover
        hidden.remove();
        btn.innerText = "Selecionar";
        btn.classList.remove("remover");
        card.classList.remove("selecionado");
    } else {
        // adicionar
        hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "brinquedos";
        hidden.value = id;
        hidden.id = inputId;
        container.appendChild(hidden);

        btn.innerText = "Remover";
        btn.classList.add("remover");
        card.classList.add("selecionado");
    }
}


    function carouselNext(btn){
    const carousel = btn.closest(".evento-carousel");
    const imgs = carousel.querySelectorAll(".carousel-img");
    let index = parseInt(carousel.dataset.index);

    imgs[index].classList.remove("active");
    index = (index + 1) % imgs.length;
    imgs[index].classList.add("active");

    carousel.dataset.index = index;
}

function carouselPrev(btn){
    const carousel = btn.closest(".evento-carousel");
    const imgs = carousel.querySelectorAll(".carousel-img");
    let index = parseInt(carousel.dataset.index);

    imgs[index].classList.remove("active");
    index = (index - 1 + imgs.length) % imgs.length;
    imgs[index].classList.add("active");

    carousel.dataset.index = index;
}


function openDetalhes(titulo, descricao, brinquedos){
    modalDetalhes.style.display = "flex";

    detalhesTitulo.innerText = titulo;
    detalhesDescricao.innerText = descricao;

    detalhesBrinquedos.innerHTML = "";

    brinquedos.forEach(nome=>{
        const li = document.createElement("li");
        li.innerText = "‚Ä¢ " + nome;
        detalhesBrinquedos.appendChild(li);
    });
}


document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".evento-carousel").forEach(carousel => {
        const imgs = carousel.querySelectorAll(".carousel-img");
        if (imgs.length <= 1) return;

        let index = 0;

        setInterval(() => {
            imgs[index].classList.remove("active");
            index = (index + 1) % imgs.length;
            imgs[index].classList.add("active");
            carousel.dataset.index = index;
        }, 4000);
    });
});


    const confirmInput = document.getElementById("confirmDeleteInput");
const btnDelete = document.getElementById("btnConfirmDelete");

confirmInput?.addEventListener("input", () => {
    if (confirmInput.value === "EXCLUIR") {
        btnDelete.disabled = false;
    } else {
        btnDelete.disabled = true;
    }
});

</script>

{% endblock %}
