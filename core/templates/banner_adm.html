{% extends 'base_adm.html' %}
{% block content %}

<style>
:root {
    --primary: #2563eb;
    --primary-dark: #1e40af;
    --success: #16a34a;
    --danger: #dc2626;
    --bg: #f1f5f9;
    --card: #ffffff;
    --radius: 18px;
    --shadow: rgba(0,0,0,0.15);
}

body {
    background: var(--bg);
}

/* ===== Container ===== */
.page-container {
    max-width: 1200px;
    margin: auto;
    padding: 20px;
}

.page-title {
    text-align: center;
    font-size: 1.9rem;
    margin-bottom: 30px;
}

/* ===== Card ===== */
.card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: 0 12px 30px var(--shadow);
    margin-bottom: 30px;
}

/* ===== Form Upload ===== */
.upload-form, .update-form {
    max-width: 520px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.upload-box {
    width: 100%;
    border: 2px dashed #cbd5e1;
    border-radius: var(--radius);
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: 0.3s;
    margin-bottom: 20px;
    position: relative;
    background: #f8fafc;
}

.upload-box:hover {
    border-color: var(--primary);
    background: #e0f2fe;
}

.upload-box strong {
    font-size: 1.1rem;
    color: #1e3a8a;
}

.upload-box span {
    display: block;
    font-size: 0.95rem;
    margin-top: 6px;
    color: #475569;
}

.upload-box input {
    display: none;
}

.upload-preview img {
    max-width: 260px;
    border-radius: 14px;
    box-shadow: 0 8px 20px var(--shadow);
}

/* ===== Grid ===== */
.banner-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 24px;
    justify-items: center;
}

/* ===== Banner Card ===== */
.banner-wrapper {
    text-align: center;
    position: relative;
}

.banner-card {
    position: relative;
    border-radius: var(--radius);
    overflow: hidden;
    cursor: pointer;
    box-shadow: 0 10px 25px var(--shadow);
    transition: 0.3s;
    width: 100%;
}

.banner-card img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: var(--radius);
}

.banner-card:hover {
    transform: translateY(-5px);
}

.banner-info {
    margin-top: 8px;
    font-size: 0.85rem;
    color: #475569;
}

/* ===== Card Actions ===== */
.banner-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-top: 10px;
    flex-wrap: wrap;
}

.banner-actions button {
    padding: 6px 14px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-size: 0.85rem;
    transition: 0.3s;
    font-weight: 500;
}

.btn-edit {
    background: #facc15;
    color: #1f2937;
}

.btn-edit:hover {
    background: #f59e0b;
    color: #fff;
}

.btn-delete {
    background: var(--danger);
    color: #fff;
}

.btn-delete:hover {
    background: #b91c1c;
}

/* ===== Modal ===== */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 999;
    padding: 15px;
}

.modal-content {
    background: #fff;
    border-radius: var(--radius);
    padding: 30px;
    width: 100%;
    max-width: 420px;
    text-align: center;
}

.modal-content h3 {
    margin-bottom: 10px;
    color: #1e40af;
}

.modal-content p {
    font-size: 0.95rem;
    color: #475569;
}

/* ===== Bot√µes ===== */
button {
    background: var(--primary);
    color: #fff;
    border: none;
    padding: 14px 26px;
    border-radius: 14px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: 0.3s;
}

button:hover {
    background: var(--primary-dark);
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}


.modal-content input[type="text"],
.modal-content input[type="file"] {
    width: 100%;
    margin: 20px 0;
    padding: 14px;
    border-radius: 14px;
    border: 1px solid #cbd5e1;
    font-size: 1rem;
    transition: 0.3s;
}

.modal-content input[type="file"] {
    cursor: pointer;
    background: #f1f5f9;
}

.modal-content input[type="file"]:hover {
    background: #e0f2fe;
}

/* ===== Modal Buttons ===== */
.modal-actions {
    display: flex;
    gap: 10px;
}

.modal-actions button {
    flex: 1;
    padding: 12px;
    border-radius: 14px;
    border: none;
    font-size: 1rem;
    cursor: pointer;
}

.btn-cancel {
    background: #e5e7eb;
}

.btn-danger {
    background: var(--danger);
    color: #fff;
    opacity: 0.7;
}

.btn-danger.active {
    opacity: 1;
}

.btn-primary {
    background: var(--primary);
    color: #fff;
    transition: 0.3s;
}

.btn-primary:hover {
    background: var(--primary-dark);
}

/* Mensagem de vazio */
.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 40px 0;
    font-size: 1.1rem;
    color: #64748b;
}

/* ===== Responsivo ===== */
@media(max-width:600px){
    .banner-card img {
        height: 150px;
    }
    .banner-actions {
        flex-direction: column;
    }
}


/* ===== Dropzone Estilizado ===== */
.update-dropzone {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    width: 100%;
    padding: 30px;
    border: 2px dashed #cbd5e1;
    border-radius: 16px;
    background: #f8fafc;
    transition: 0.3s;
    margin-bottom: 20px;
    position: relative;
    text-align: center;
}

.update-dropzone:hover {
    border-color: #2563eb;
    background: #e0f2fe;
}

.update-dropzone .dropzone-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.update-dropzone .icon-upload {
    color: #2563eb;
}

.update-dropzone span {
    font-size: 1rem;
    color: #1e3a8a;
    font-weight: 500;
}

/* Esconde o input real */
.update-dropzone input[type="file"] {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

/* Preview do arquivo selecionado */
.update-dropzone img {
    max-width: 200px;
    margin-top: 12px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Mobile responsivo */
@media(max-width:600px){
    .update-dropzone {
        padding: 20px;
    }
    .update-dropzone span {
        font-size: 0.95rem;
    }
}


    .upload-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 14px;
    width: 100%;
    margin-bottom: 20px;
}

.upload-preview-grid img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.2);
}

    .btn-cancel {
    background: #e5e7eb !important;
    color: #1f2937 !important;
}

.btn-cancel:hover {
    background: #d1d5db !important;
}

.preview-item {
    position: relative;
}

.preview-item img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 14px;
}

.preview-item button {
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(0,0,0,0.75);
    color: #fff;
    border: none;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

.preview-item button:hover {
    background: #dc2626;
}

    /* Sobrescreve t√≠tulos apenas dentro dos cards nesta p√°gina */
.page-container h2,
.page-container h3 {
    color: #111 !important;  /* preto forte */
}

    .page-title {
    color: #111;  /* t√≠tulo da p√°gina preto */
}

.card h2,
.card h3 {
    color: #111;  /* t√≠tulos dentro dos cards preto */
}
</style>

<div class="page-container">
    <h2 class="page-title">Gerenciar Banners</h2>

    <!-- Upload Banner -->
    <div class="card">
    <h3>Adicionar novo banner</h3>


<p style="margin-bottom:12px; color:#475569; text-align:center;">
    Voc√™ pode adicionar
    <strong>{{ limite_restante }}</strong>
    banner{{ limite_restante|pluralize }} (m√°x. {{ max_banners }}).
</p>

    <form method="post" enctype="multipart/form-data" class="upload-form">
        {% csrf_token %}

        <label class="upload-box {% if limite_restante == 0 %}disabled{% endif %}">
            <strong>Clique ou arraste a imagem aqui</strong>
            <span>PNG, JPG ou WEBP</span>

            <input
                type="file"
                name="imagens"
                id="uploadInput"
                accept="image/*"
                multiple
                {% if limite_restante == 0 %}disabled{% endif %}
            >
        </label>

        <div class="upload-preview-grid" id="preview"></div>

        <button type="submit" {% if limite_restante == 0 %}disabled{% endif %}>
            Salvar banner
        </button>
    </form>
</div>

    <!-- Grid de banners -->
    <div class="card">
        <h3>Banners existentes</h3>

        <div class="banner-grid">
            {% for banner in imagens_site %}
                <div class="banner-wrapper">
                    <div class="banner-card">
                        {% if banner.imagem %}
                            <img src="{{ banner.imagem.url }}" alt="Banner">
                        {% else %}
                            <div class="no-image">Sem imagem</div>
                        {% endif %}
                    </div>

                    <small class="banner-info">
                        Criado em {{ banner.criacao|date:"d/m/Y" }}<br>
                        {{ banner.status_atualizacao }}
                    </small>

                    <div class="banner-actions">
                        <button class="btn-edit" onclick="openUpdateModal('{{ banner.id }}')">Alterar</button>
                        <button class="btn-delete" onclick="openDeleteModal('{{ banner.id }}')">Excluir</button>
                    </div>

                    <!-- Formul√°rios escondidos -->
                    <form id="delete-form-{{ banner.id }}" method="post" action="{% url 'banner_delete' banner.id %}">{% csrf_token %}</form>
                    <form id="update-form-{{ banner.id }}" method="post" enctype="multipart/form-data" action="{% url 'banner_adm' %}">
                        {% csrf_token %}
                        <input type="file" name="imagem" class="update-input" style="display:none;">
                        <input type="hidden" name="update_id" value="{{ banner.id }}">
                    </form>
                </div>
            {% empty %}
                <div class="empty-state">
                    <p>üö´ Nenhum banner cadastrado</p>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modal Exclus√£o -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <h3>Confirma√ß√£o necess√°ria</h3>
        <p>Digite <strong>EXCLUIR</strong> para remover este banner.</p>
        <input type="text" id="confirmInput" placeholder="EXCLUIR">
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeDeleteModal()">Cancelar</button>
            <button class="btn-danger" id="confirmDelete" disabled>Excluir</button>
        </div>
    </div>
</div>

<!-- Modal Atualiza√ß√£o -->
<div class="modal" id="updateModal">
    <div class="modal-content">
        <h3>Alterar Banner</h3>
        <p>Escolha uma nova imagem</p>

        <!-- Dropzone moderno -->
        <label class="update-dropzone" for="updateFileInput">
            <div class="dropzone-content">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon-upload" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="40" height="40">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M12 12v8m0-8l-4 4m4-4l4 4M12 4v8"/>
                </svg>
                <span id="updateFileLabel">Clique ou arraste para selecionar a imagem</span>
            </div>
            <input type="file" id="updateFileInput" accept="image/*">
        </label>

        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeUpdateModal()">Cancelar</button>
            <button class="btn-primary" id="confirmUpdate">Salvar</button>
        </div>
    </div>
</div>

<script>
let selectedDeleteId = null;
let selectedUpdateId = null;

/* Exclus√£o */
function openDeleteModal(id){
    selectedDeleteId = id;
    document.getElementById('deleteModal').style.display = 'flex';
}
function closeDeleteModal(){
    document.getElementById('deleteModal').style.display = 'none';
    document.getElementById('confirmInput').value = '';
    document.getElementById('confirmDelete').disabled = true;
    document.getElementById('confirmDelete').classList.remove('active');
}
document.getElementById('confirmInput').addEventListener('input', function () {
    const btn = document.getElementById('confirmDelete');
    if(this.value === 'EXCLUIR'){
        btn.disabled = false;
        btn.classList.add('active');
    } else {
        btn.disabled = true;
        btn.classList.remove('active');
    }
});
document.getElementById('confirmDelete').addEventListener('click', function(){
    document.getElementById(`delete-form-${selectedDeleteId}`).submit();
    closeDeleteModal();
});

/* Atualiza√ß√£o */
function openUpdateModal(id){
    selectedUpdateId = id;
    document.getElementById('updateModal').style.display = 'flex';
}
function closeUpdateModal(){
    document.getElementById('updateModal').style.display = 'none';
    document.getElementById('updateFileInput').value = '';
}
document.getElementById('confirmUpdate').addEventListener('click', function(){
    const fileInput = document.getElementById('updateFileInput');
    if(fileInput.files.length > 0){
        const updateForm = document.getElementById(`update-form-${selectedUpdateId}`);
        updateForm.querySelector('.update-input').files = fileInput.files;
        updateForm.submit();
        closeUpdateModal();
    } else {
        alert('Selecione uma imagem para atualizar');
    }
});

// Preview moderno dentro do modal
const updateInput = document.getElementById('updateFileInput');
const updateLabel = document.getElementById('updateFileLabel');

updateInput.addEventListener('change', function(){
    if(this.files && this.files[0]){
        const fileName = this.files[0].name;
        updateLabel.textContent = `Selecionado: ${fileName}`;

        // Opcional: mostrar preview da imagem
        const preview = document.createElement('img');
        preview.src = URL.createObjectURL(this.files[0]);

        // Remove preview antigo
        const oldPreview = document.querySelector('.update-dropzone img');
        if(oldPreview) oldPreview.remove();

        document.querySelector('.update-dropzone').appendChild(preview);
    } else {
        updateLabel.textContent = "Clique ou arraste para selecionar a imagem";
    }
});


const uploadInput = document.getElementById('uploadInput');
const preview = document.getElementById('preview');
const limiteRestante = {{ limite_restante|default:0 }};

// Buffer real dos arquivos
let fileBuffer = new DataTransfer();

if (uploadInput) {
    uploadInput.addEventListener('change', function () {
        const files = Array.from(this.files);

        files.forEach(file => {
            if (!file.type.startsWith('image/')) return;
            if (fileBuffer.files.length >= limiteRestante) return;

            // evita duplicados
            const exists = Array.from(fileBuffer.files)
                .some(f => f.name === file.name && f.size === file.size);
            if (exists) return;

            fileBuffer.items.add(file);

            const wrapper = document.createElement('div');
            wrapper.className = 'preview-item';

            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.onload = () => URL.revokeObjectURL(img.src);

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.innerHTML = '&times;';

            removeBtn.addEventListener('click', () => {
                removeFile(file);
                wrapper.remove();
            });

            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            preview.appendChild(wrapper);
        });

        uploadInput.files = fileBuffer.files;
    });
}

function removeFile(fileToRemove) {
    const newBuffer = new DataTransfer();

    Array.from(fileBuffer.files).forEach(file => {
        if (file !== fileToRemove) {
            newBuffer.items.add(file);
        }
    });

    fileBuffer = newBuffer;
    uploadInput.files = fileBuffer.files;
}
</script>

{% endblock %}