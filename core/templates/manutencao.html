{% extends "base.html" %}

{% load widget_tweaks %}


{% block content %}

<style>
/* ======= CONTAINER GERAL ======= */
.manutencao-header,
.manutencao-tabs,
.tab-content,
.breadcrumb {
    max-width: 900px;
    margin: 0 auto;
}


/* ===== BREADCRUMB ===== */
.breadcrumb {
    max-width: 1200px;
    margin: 30px auto 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.95rem;
}

.breadcrumb a {
    color: #004AAD;
    text-decoration: none;
    font-weight: 600;
    transition: opacity 0.2s ease;
}

.breadcrumb a:hover {
    opacity: 0.75;
}

.breadcrumb span {
    color: #888;
}

.breadcrumb span:not(:last-child)::after {
    content: "‚Ä∫";
    margin-left: 8px;
    color: #bbb;
}

/* ======= CABE√áALHO ======= */
.manutencao-header {
    text-align: center;
    margin-bottom: 20px;
    position: relative;
}

.manutencao-header h1 {
    font-size: 32px;
    font-weight: 600;
    margin-bottom: 8px;
}

.manutencao-header p {
    font-size: 18px;           /* maior e mais leg√≠vel */
    font-weight: 600;           /* mais destaque */
    color: #fff;            /* azul escuro mais vis√≠vel */
    line-height: 1.6;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1); /* leve sombra para destacar sobre o fundo */
}

/* ======= ABAS ======= */
/* ======= ABAS ======= */
.manutencao-tabs {
    display: flex;
    justify-content: center;
    gap: 15px;               /* aumenta o espa√ßamento entre os bot√µes */
    margin-bottom: 20px;
}

.tab-btn {
    padding: 14px 28px;      /* bot√µes maiores */
    border: none;
    background: #f0f4ff;     /* leve tom azul de fundo */
    color: #004AAD;          /* cor mais forte */
    border-radius: 35px;     /* ainda arredondados */
    cursor: pointer;
    font-size: 16px;         /* fonte maior */
    font-weight: 600;        /* mais enf√°tico */
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* sombra sutil */
}

.tab-btn:hover {
    background: #dce4ff;     /* destaca ao passar o mouse */
    transform: translateY(-2px); /* leve "elevada" ao hover */
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}

.tab-btn.active {
    background: #0d6efd;     /* azul principal */
    color: #fff;
    box-shadow: 0 6px 20px rgba(13, 110, 253, 0.35); /* sombra mais intensa */
    transform: translateY(-2px); /* sutil eleva√ß√£o */
}


/* ======= CONTE√öDO DAS ABAS ======= */
.tab-content {
    display: none; /* escondemos todas por padr√£o */
    margin-top: 10px;
}

.tab-content.active {
    display: block; /* exibimos somente a ativa */
}

/* ======= FORMUL√ÅRIO ======= */
.manutencao-form {
    background: #ffffff;
    padding: 35px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    max-width: 900px;
    margin: 0 auto 30px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    min-height: 90px;
    resize: vertical;
}

.manutencao-form .form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 18px;
}

.manutencao-form .form-group label {
    font-size: 19.9px;      /* aumenta o tamanho */
    font-weight: 600;       /* deixa mais forte */
    color: #0d3b99;         /* azul elegante */
    margin-bottom: 6px;
}

/* Foco no campo destaca o label */
.manutencao-form .form-group:focus-within label {
    color: #0d6efd;
}

.manutencao-form input,
.manutencao-form textarea,
.manutencao-form select {
    padding: 10px 12px;
    font-size: 14px;
}


.manutencao-form .form-group input:focus,
.manutencao-form .form-group textarea:focus,
.manutencao-form .form-group select:focus {
    outline: none;
    border-color: #0d6efd;
}

/* ======= BOT√ÉO ======= */
.btn-enviar {
    margin-top: 10px;
    border: none;
    border-radius: 30px;
    background: #0d6efd;
    color: #fff;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    grid-column: span 2;      /* ocupa as 2 colunas */
    justify-self: center;     /* centraliza horizontalmente */
    margin-top: 30px;         /* espa√ßo acima */
    padding: 16px 50px;       /* bot√£o mais ‚Äúpremium‚Äù */
    width: auto;
}

.btn-enviar:hover {
    background: #084fc7;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(13, 110, 253, 0.35);
}

/* ======= TABELA ======= */
.tabela-wrapper {
    background: #fff;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    max-width: 900px;
    margin: 0 auto 30px;
}

.tabela-manutencoes {
    width: 100%;
    border-collapse: collapse;
}

.tabela-manutencoes thead {
    background: #f5f7ff;
}

.tabela-manutencoes th {
    text-align: left;
    padding: 14px;
    font-size: 14px;
    color: #004AAD;
    font-weight: 600;
}

.tabela-manutencoes td {
    padding: 14px;
    border-top: 1px solid #eee;
    font-size: 14px;
}

.tabela-manutencoes tr:hover {
    background: #f9fbff;
}

.sem-registros {
    text-align: center;
    padding: 30px;
    color: #777;
}

/* ===== BOT√ÉO VER (APP STYLE) ===== */
.btn-detalhe {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 20px;
    background: linear-gradient(135deg, #0d6efd, #004AAD);
    color: #fff;
    font-weight: 600;
    font-size: 13px;
    border: none;
    cursor: pointer;
    transition: all 0.25s ease;
    box-shadow: 0 4px 12px rgba(13,110,253,0.35);
}

.btn-detalhe::before {
    content: "üëÅÔ∏è";
    font-size: 14px;
}

.btn-detalhe:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(13,110,253,0.45);
}

.btn-selecionar-brinquedo {
    padding: 16px 24px;
    border-radius: 12px;
    border: 2px dashed #0d6efd;
    background: #f0f8ff;
    color: #0d6efd;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    text-align: center;
    transition: all 0.2s ease;
}

.btn-selecionar-brinquedo:hover {
    background: #dcecff;
    transform: translateY(-2px);
}

.modal-brinquedos {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    overflow-y: auto;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn { from {opacity: 0;} to {opacity:1;} }


.modal-content {
    background: #fff;
    margin: 50px auto;
    border-radius: 16px;
    max-width: 900px;
    padding: 20px 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.modal-header h2 {
    margin: 0;
    font-size: 24px;
    color: #0d3b99;


 }
.close-modal {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #888;
    transition: 0.2s;
}

.modal-ordenacao {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}


.close-modal:hover {
    color: #0d3b99;
}

.modal-filtros {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.modal-filtros input, .modal-filtros select {
    padding: 8px 12px;
    font-size: 14px;
    border-radius: 8px;
    border: 1px solid #ccc;
}

.btn-ordenar {
    flex: 1;
    padding: 10px 0;
    border-radius: 12px;
    border: 2px solid #0d6efd;
    background: #f0f8ff;
    color: #0d6efd;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-ordenar.active, .btn-ordenar:hover {
    background: #0d6efd;
    color: #fff;
}

/* Pesquisa */
.modal-pesquisa {
    margin-bottom: 15px;
}

.modal-pesquisa input {
    width: 100%;
    padding: 10px 14px;
    font-size: 14px;
    border-radius: 10px;
    border: 1px solid #ccc;
}

/* Lista de brinquedos */
.lista-brinquedos {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
}

.item-brinquedo {
    background: #f9f9f9;
    border-radius: 12px;
    padding: 10px;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.item-brinquedo img, .placeholder-img {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
}

.item-brinquedo strong {
    font-size: 14px;
    color: #0d3b99;
}

.item-brinquedo:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}


/* Bot√£o de selecionar brinquedo */
.btn-selecionar-brinquedo {
    width: 100%;
    padding: 14px;
    border-radius: 30px;
    background: #0d6efd;
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
}
.btn-selecionar-brinquedo:hover {
    background: #084fc7;
}

/* Modal */
.modal-brinquedos {
    display: none;
    position: fixed;
    z-index: 9999;
    left:0; top:0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    overflow-y: auto;
}

.modal-content {
    background: #fff;
    margin: 50px auto;
    border-radius: 16px;
    max-width: 900px;
    padding: 20px 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.modal-header h2 {
    margin: 0;
    font-size: 24px;
    color: #0d3b99;
}

.close-modal {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #888;
}
.close-modal:hover {
    color: #0d3b99;
}

/* Ordena√ß√£o */
.modal-ordenacao {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}
.btn-ordenar {
    flex: 1;
    padding: 10px 0;
    border-radius: 12px;
    border: 2px solid #0d6efd;
    background: #f0f8ff;
    color: #0d6efd;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-ordenar.active, .btn-ordenar:hover {
    background: #0d6efd;
    color: #fff;
}

/* Pesquisa */
.modal-pesquisa input {
    width: 100%;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid #ccc;
    margin-bottom: 15px;
}

/* Lista de brinquedos */
.lista-brinquedos {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 15px;
}
.item-brinquedo {
    background: #f9f9f9;
    border-radius: 12px;
    padding: 10px;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
}
.item-brinquedo img, .placeholder-img {
    width: 100px;
    height: 100px;
    border-radius: 8px;
    object-fit: cover;
    margin-bottom: 10px;
}
.item-brinquedo strong {
    font-size: 14px;
    color: #0d3b99;
}
.item-brinquedo:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.manutencao-guest {
    display: flex;
    justify-content: center;
    margin: 40px 0;
}

.guest-card {
    max-width: 420px;
    width: 100%;
    background: #ffffff;
    border-radius: 16px;
    padding: 32px 26px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
}

.guest-icon {
    font-size: 42px;
    margin-bottom: 10px;
}

.guest-card h2 {
    font-size: 1.4rem;
    margin-bottom: 10px;
    color: #222;
}

.guest-text {
    font-size: 0.95rem;
    color: #555;
    margin-bottom: 20px;
    line-height: 1.5;
}

.guest-beneficios {
    list-style: none;
    padding: 0;
    margin: 0 0 24px;
    text-align: left;
}

.guest-beneficios li {
    font-size: 0.85rem;
    color: #333;
    margin-bottom: 8px;
}

.guest-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Bot√µes */
.btn-primario {
    background: linear-gradient(135deg, #004AAD, #0066ff);
    color: #fff;
    padding: 12px;
    border-radius: 30px;
    font-weight: 600;
    text-decoration: none;
    transition: transform .2s ease, box-shadow .2s ease;
}

.btn-primario:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 74, 173, 0.35);
}

.btn-secundario {
    background: transparent;
    border: 2px solid #004AAD;
    color: #004AAD;
    padding: 10px;
    border-radius: 30px;
    font-weight: 600;
    text-decoration: none;
    transition: background .2s ease, color .2s ease;
}

.btn-secundario:hover {
    background: #004AAD;
    color: #fff;
}


/* ===== UPLOAD DE FOTOS MODERNO ===== */
.fotos-group {
    align-items: center;
}

.upload-card {
    width: 100%;
    max-width: 360px;
    margin: 10px auto 0;
    padding: 24px;
    border-radius: 16px;
    border: 2px dashed #0d6efd;
    background: #f0f8ff;
    text-align: center;
    cursor: pointer;
    transition: all 0.25s ease;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.upload-card:hover {
    background: #e3efff;
    transform: translateY(-2px);
}

.upload-icon {
    font-size: 36px;
}

.upload-card strong {
    font-size: 15px;
    color: #0d3b99;
}

.upload-card span {
    font-size: 13px;
    color: #555;
}

/* Preview */
.upload-preview {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 14px;
}

.preview-item {
    position: relative;
    width: 90px;
    height: 90px;
}

.preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

/* Bot√£o remover */
.preview-item button {
    position: absolute;
    top: -6px;
    right: -6px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: none;
    background: #E63946;
    color: #fff;
    font-size: 13px;
    cursor: pointer;
}

.brinquedo-card {
    position: relative;
    max-width: 200px;
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    padding: 12px;
    text-align: center;
    margin-top: 10px;
    animation: fadeIn 0.25s ease;
}

.brinquedo-card img {
    width: 100%;
    height: 140px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 8px;
}

.brinquedo-card span {
    font-size: 14px;
    font-weight: 600;
    color: #0d3b99;
}

.remove-brinquedo {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: none;
    background: #e63946;
    color: #fff;
    font-size: 18px;
    cursor: pointer;
    line-height: 1;
    transition: transform 0.2s;
}

.remove-brinquedo:hover {
    transform: scale(1.1);
}

    .campo-erro {
    border: 2px solid #e63946 !important;
    background: #fff5f5;
}

.cep-feedback {
    font-size: 12px;
    margin-top: 4px;
    min-height: 14px;
}

.cep-loading {
    color: #555;
}

.cep-error {
    color: #e63946;
}

.cep-success {
    color: #2a9d8f;
}

.campo-loading {
    border-color: #0d6efd !important;
    background: #f0f8ff;
}

.campo-bloqueado {
    background: #f3f5f8;
    color: #777;
    cursor: not-allowed;
}

.campo-bloqueado::placeholder {
    color: #aaa;
}

/* ===== MODAL DETALHE MANUTEN√á√ÉO ===== */
.modal-detalhe-body {
    display: flex;
    flex-direction: column;
    gap: 18px;
}

.detalhe-card {
    background: #f9fbff;
    border-radius: 14px;
    padding: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}

.detalhe-card h4 {
    margin: 0 0 10px;
    font-size: 14px;
    color: #0d3b99;
}

.detalhe-info {
    font-size: 14px;
    color: #333;
    line-height: 1.6;
}

.status-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
}

.status-P { background:#fff3cd; color:#856404; }
.status-A { background:#cce5ff; color:#004085; }
.status-C { background:#d4edda; color:#155724; }
.status-X { background:#f8d7da; color:#721c24; }

/* ===== FOTOS ===== */
.detalhe-fotos {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.detalhe-fotos img {
    width: 90px;
    height: 90px;
    object-fit: cover;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

/* ===== WHATSAPP ===== */
.btn-whatsapp {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 14px;
    border-radius: 30px;
    background: linear-gradient(135deg, #25D366, #128C7E);
    color: #fff;
    font-weight: 700;
    text-decoration: none;
    font-size: 15px;
    transition: all 0.25s ease;
    margin-top: 10px;
}

.btn-whatsapp:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(37,211,102,0.45);
}

/* ===== RESPONSIVIDADE ===== */
@media (max-width: 1024px) {
    .manutencao-form {
        grid-template-columns: 1fr; /* uma coluna s√≥ */
        gap: 10px;
        padding: 25px;
    }

    .btn-enviar {
        width: 100%;
        padding: 14px 0;
    }

    .tabela-wrapper {
        padding: 15px;
        overflow-x: auto; /* permite scroll horizontal em tabelas grandes */
    }

    .tabela-manutencoes th,
    .tabela-manutencoes td {
        font-size: 13px;
        padding: 10px;
    }

    .manutencao-tabs {
        flex-wrap: wrap;
        gap: 10px;
    }

    .tab-btn {
        flex: 1 1 calc(50% - 10px);
        padding: 12px 10px;
        font-size: 14px;
    }

    .breadcrumb {
        font-size: 0.85rem;
        gap: 6px;
    }
}

@media (max-width: 600px) {
    .manutencao-form {
        padding: 20px;
    }

    .manutencao-header h1 {
        font-size: 26px;
    }

    .manutencao-header p {
        font-size: 16px;
    }

    .tab-btn {
        flex: 1 1 100%;
        padding: 10px 8px;
        font-size: 13px;
    }

    .tabela-manutencoes th,
    .tabela-manutencoes td {
        font-size: 12px;
        padding: 8px;
    }

    .guest-card {
        padding: 24px 20px;
    }

    .btn-selecionar-brinquedo,
    .btn-enviar {
        width: 100%;
        padding: 12px 0;
        font-size: 15px;
    }

    .upload-card {
        max-width: 100%;
        padding: 20px;
    }

    .lista-brinquedos {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }

    .brinquedo-card img {
        height: 120px;
    }

    .detalhe-fotos img {
        width: 70px;
        height: 70px;
    }
}

</style>

{% if not user.is_authenticated %}
<!-- ======= BREADCRUMB ======= -->
<nav class="breadcrumb" id="bread">
    <a href="{% url 'home' %}">Home</a>
    <span></span>
    <span>Manuten√ß√µes</span>
</nav>


<div class="manutencao-guest">

    <div class="guest-card">
        <div class="guest-icon">üîß</div>

        <h2>√Årea exclusiva para clientes</h2>

        <p class="guest-text">
            Para solicitar manuten√ß√µes, acompanhar pedidos e receber atualiza√ß√µes,
            voc√™ precisa estar logado.
        </p>

        <ul class="guest-beneficios">
            <li>‚úî Solicitar manuten√ß√£o online</li>
            <li>‚úî Acompanhar status do pedido</li>
            <li>‚úî Hist√≥rico de manuten√ß√µes</li>
        </ul>

        <div class="guest-actions">
            <a href="{% url 'registrar' %}#register-box" class="btn-primario">
                Criar conta gratuita
            </a>

            <a href="{% url 'login' %}#login-box" class="btn-secundario">
                J√° tenho conta
            </a>
        </div>
    </div>

</div>
{% endif %}


{% if user.is_authenticated %}
<!-- ======= CABE√áALHO ======= -->
<header class="manutencao-header" id="cab">
    <h1>Manuten√ß√µes</h1>
    <p>Solicite uma nova manuten√ß√£o ou acompanhe suas solicita√ß√µes</p>
</header>

<!-- ======= ABAS ======= -->

<div class="manutencao-tabs" id="tab">
    <button class="tab-btn {% if tab_ativa == 'nova' %}active{% endif %}" data-tab="nova">
        Solicitar manuten√ß√£o
    </button>
    <button class="tab-btn {% if tab_ativa == 'lista' %}active{% endif %}" data-tab="lista">
        Manuten√ß√µes solicitadas
    </button>
</div>
{% endif %}

<!-- ======= ABA: NOVA MANUTEN√á√ÉO ======= -->
{% if user.is_authenticated %}
<section class="tab-content {% if tab_ativa == 'nova' %}active{% endif %}" id="nova">
            <form method="post" enctype="multipart/form-data" class="manutencao-form">

                {% csrf_token %}
                {{ form.non_field_errors }}

            <div class="form-group" style="grid-column: span 2;">
    <label>Brinquedo</label>

    <!-- Bot√£o selecionar -->
    <button type="button"
            id="selecionar-brinquedo-btn"
            class="btn-selecionar-brinquedo">
        Clique para selecionar um brinquedo
    </button>

    <!-- Card do brinquedo selecionado -->
    <div id="brinquedo-card" class="brinquedo-card" style="display:none;">
        <button type="button" class="remove-brinquedo">&times;</button>
        <img id="brinquedo-img" src="" alt="">
        <span id="brinquedo-nome"></span>
    </div>

    <input type="hidden" name="brinquedo" id="brinquedo-input">
</div>

        <div class="form-group">{{ form.descricao.label_tag }}{{ form.descricao }}</div>

       <div class="form-group">
            {{ form.telefone_contato.label_tag }}
            {% render_field form.telefone_contato class="mask-telefone" %}
        </div>

        <div class="form-group">
    {{ form.cep.label_tag }}
    {% render_field form.cep class="mask-cep" id="id_cep" %}
    <small class="cep-feedback" id="cepFeedback"></small>
</div>

        <div class="form-group">{{ form.endereco.label_tag }}{{ form.endereco }}</div>
        <div class="form-group">{{ form.numero.label_tag }}{{ form.numero }}</div>
        <div class="form-group">{{ form.complemento.label_tag }}{{ form.complemento }}</div>
        <div class="form-group">{{ form.bairro.label_tag }}{{ form.bairro }}</div>
        <div class="form-group">{{ form.cidade.label_tag }}{{ form.cidade }}</div>
        <div class="form-group">{{ form.estado.label_tag }}{{ form.estado }}</div>

        <div class="form-group fotos-group" style="grid-column: span 2;">
            <label>Fotos do problema</label>

            <input type="file" name="imagens" id="imagens" multiple accept="image/*" hidden>

            <div class="upload-card" id="uploadCard">
                <div class="upload-icon">üì∑</div>
                <strong>Clique para adicionar fotos</strong>
                <span id="uploadInfo">At√© 5 imagens</span>
            </div>

            <div class="upload-preview" id="preview"></div>
        </div>

        <button type="submit" class="btn-enviar">Enviar solicita√ß√£o</button>
    </form>
</section>


<!-- ======= ABA: LISTA ======= -->

<section class="tab-content {% if tab_ativa == 'lista' %}active{% endif %}" id="lista">
    <div class="tabela-wrapper">
        <table class="tabela-manutencoes">
            <thead>
                <tr>
                    <th>Brinquedo</th>
                    <th>Status</th>
                    <th>Data</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
            {% if manutencoes %}
                {% for manutencao in manutencoes %}
                    <tr>
                        <td>{{ manutencao.brinquedo }}</td>
                        <td><span class="status status-{{ manutencao.status }}">{{ manutencao.get_status_display }}</span></td>
                        <td>{{ manutencao.criado_em|date:"d/m/Y H:i" }}</td>
                        <td>
                            <button
                                class="btn-detalhe"
                                data-id="{{ manutencao.id }}"
                                data-brinquedo="{{ manutencao.brinquedo }}"
                                data-status="{{ manutencao.get_status_display }}"
                                data-descricao="{{ manutencao.descricao }}"
                                data-data="{{ manutencao.criado_em|date:'d/m/Y H:i' }}"
                                data-telefone="{{ manutencao.telefone_contato }}"
                                data-cep="{{ manutencao.cep }}"
                                data-endereco="{{ manutencao.endereco }}"
                                data-bairro="{{ manutencao.bairro }}"
                                data-cidade="{{ manutencao.cidade }}"
                                data-estado="{{ manutencao.estado }}"
                                data-imagens='[
                                   {% for img in manutencao.imagens.all %}
                                       "{{ img.imagem.url }}"{% if not forloop.last %},{% endif %}
                                   {% endfor %}
                               ]'>
                                Ver
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="4" class="sem-registros">Nenhuma manuten√ß√£o solicitada.</td></tr>
            {% endif %}

            </tbody>
        </table>
    </div>
</section>
{% endif %}

{% if messages %}
<div id="modal-sucesso" class="modal-brinquedos" style="display:none;">
    <div class="modal-content" style="max-width:420px;text-align:center;">
        <div class="modal-header">
            <h2>Sucesso üéâ</h2>
            <button class="close-modal">&times;</button>
        </div>

        {% for message in messages %}
            <p style="font-size:1rem;color:#333;margin:20px 0;">
                {{ message }}
            </p>
        {% endfor %}

        <a href="{% url 'manutencoes' %}?tab=lista#cab"
           class="btn-primario btn-ver-solicitacoes">
            Ver minhas solicita√ß√µes
        </a>
    </div>
</div>
{% endif %}


<!-- Modal de sele√ß√£o de brinquedos -->
<div id="modal-brinquedos" class="modal-brinquedos">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Selecione um Brinquedo</h2>
            <button class="close-modal">&times;</button>
        </div>

        <!-- Bot√µes de ordena√ß√£o -->
        <div class="modal-ordenacao">
            <button class="btn-ordenar active" data-ordem="a-z">A-Z</button>
            <button class="btn-ordenar" data-ordem="z-a">Z-A</button>
        </div>

        <!-- Pesquisa -->
        <div class="modal-pesquisa">
            <input type="text" id="pesquisa-brinquedo" placeholder="Digite para pesquisar...">
        </div>

        <!-- Lista de brinquedos -->
        <div class="lista-brinquedos">
            {% for brinquedo in brinquedos %}
                <div class="item-brinquedo" data-id="{{ brinquedo.id }}" data-nome="{{ brinquedo.nome_brinquedo }}">
                    {% if brinquedo.imagem_brinquedo %}
                        <img src="{{ brinquedo.imagem_brinquedo.url }}" alt="{{ brinquedo.nome_brinquedo }}">
                    {% else %}
                        <div class="placeholder-img">üì¶</div>
                    {% endif %}
                    <strong>{{ brinquedo.nome_brinquedo }}</strong>
                </div>
            {% empty %}
                <p>Nenhum brinquedo cadastrado.</p>
            {% endfor %}

        </div>
    </div>
</div>

<div id="modal-detalhe" class="modal-brinquedos" style="display:none;">
    <div class="modal-content" style="max-width:650px;">
        <div class="modal-header">
            <h2>üîß Detalhes da Manuten√ß√£o</h2>
            <button class="close-modal">&times;</button>
        </div>

        <div class="modal-detalhe-body">

            <!-- Brinquedo e status -->
            <div class="detalhe-card">
                <h4>Brinquedo</h4>
                <p class="detalhe-info" id="det-brinquedo"></p>
                <span id="det-status" class="status-badge"></span>
            </div>

            <!-- Descri√ß√£o -->
            <div class="detalhe-card">
                <h4>Descri√ß√£o do problema</h4>
                <p class="detalhe-info" id="det-descricao"></p>
            </div>

            <!-- Endere√ßo -->
            <div class="detalhe-card">
                <h4>Endere√ßo</h4>
                <p class="detalhe-info">
                    <span id="det-endereco"></span>,
                    <span id="det-bairro"></span><br>
                    <span id="det-cidade"></span>/<span id="det-estado"></span>
                </p>
            </div>

            <!-- Fotos -->
            <div class="detalhe-card">
                <h4>Fotos enviadas</h4>
                <div class="detalhe-fotos" id="det-fotos"></div>
            </div>

            <!-- WhatsApp -->
            <a href="#" target="_blank" id="btn-whatsapp" class="btn-whatsapp">
                üí¨ Falar pelo WhatsApp
            </a>

            <!-- Cancelar -->
            <form method="post" action="{% url 'cancelar_manutencao' %}">
                {% csrf_token %}
                <input type="hidden" name="manutencao_id" id="cancelar-id">
                <button type="submit" class="btn-secundario">
                    Cancelar manuten√ß√£o
                </button>
            </form>

        </div>
    </div>
</div>

<script>

document.addEventListener("DOMContentLoaded", () => {

   /* ===============================
       VARI√ÅVEIS GERAIS
    =============================== */
    const form = document.querySelector(".manutencao-form");

    /* ===============================
       ABAS
    =============================== */
    const tabs = document.querySelectorAll(".tab-btn");
    const contents = document.querySelectorAll(".tab-content");

    tabs.forEach(tab => {
        tab.addEventListener("click", () => {
            tabs.forEach(t => t.classList.remove("active"));
            contents.forEach(c => c.classList.remove("active"));

            tab.classList.add("active");
            document.getElementById(tab.dataset.tab).classList.add("active");
        });
    });


    /* ===============================
       MODAL BRINQUEDOS
    =============================== */
    const modal = document.getElementById("modal-brinquedos");
    const btnSelecionar = document.getElementById("selecionar-brinquedo-btn");
    const closeModal = modal.querySelector(".close-modal");
    const inputHidden = document.getElementById("brinquedo-input");
    const itens = Array.from(modal.querySelectorAll(".item-brinquedo"));
    const pesquisa = document.getElementById("pesquisa-brinquedo");
    const btnOrdenar = Array.from(modal.querySelectorAll(".btn-ordenar"));

    // Card
    const card = document.getElementById("brinquedo-card");
    const img = document.getElementById("brinquedo-img");
    const nome = document.getElementById("brinquedo-nome");
    const btnRemover = card.querySelector(".remove-brinquedo");

    bloquearEndereco();

// Abrir modal
 btnSelecionar.addEventListener("click", () => {
        modal.style.display = "block";
    });

// Fechar modal

closeModal.addEventListener("click", () => modal.style.display = "none")

window.addEventListener("click", e => {
        if (e.target === modal) modal.style.display = "none";
    });

// Selecionar brinquedo
itens.forEach(item => {
        item.addEventListener("click", () => {
            inputHidden.value = item.dataset.id;
            nome.textContent = item.dataset.nome;
            img.src = item.querySelector("img")?.src || "";

            btnSelecionar.style.display = "none";
            card.style.display = "flex";
            modal.style.display = "none";
        });
    });


// Remover brinquedo
 btnRemover.addEventListener("click", () => {
        inputHidden.value = "";
        card.style.display = "none";
        btnSelecionar.style.display = "inline-flex";
    });

    // Pesquisa em tempo real
    pesquisa.addEventListener("input", () => {
        const valor = pesquisa.value.toLowerCase();
        itens.forEach(item => {
            item.style.display = item.dataset.nome.toLowerCase().includes(valor)
                ? "flex"
                : "none";
        });
    });

    // Ordena√ß√£o A-Z / Z-A
     btnOrdenar.forEach(btn => {
        btn.addEventListener("click", () => {
            btnOrdenar.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");

            const ordem = btn.dataset.ordem;
            const container = modal.querySelector(".lista-brinquedos");

            itens
                .sort((a, b) =>
                    ordem === "a-z"
                        ? a.dataset.nome.localeCompare(b.dataset.nome)
                        : b.dataset.nome.localeCompare(a.dataset.nome)
                )
                .forEach(i => container.appendChild(i));
        });
    });


 /* ===============================
       VALIDA√á√ÉO DO FORM
    =============================== */
    form.addEventListener("submit", e => {
        if (!inputHidden.value) {
            e.preventDefault();
            alert("Selecione um brinquedo antes de enviar.");
        }
    });

 /* ===============================
       MODAL SUCESSO
    =============================== */
    const modalSucesso = document.getElementById("modal-sucesso");
    if (modalSucesso) {
        modalSucesso.style.display = "block";

        modalSucesso.querySelector(".close-modal")
            .addEventListener("click", () => {
                modalSucesso.style.display = "none";
            });

        window.addEventListener("click", e => {
            if (e.target === modalSucesso) {
                modalSucesso.style.display = "none";
            }
        });
    }

});

const modalDetalhe = document.getElementById("modal-detalhe");
const closeDetalhe = modalDetalhe.querySelector(".close-modal");

document.querySelectorAll(".btn-detalhe").forEach(btn => {
    btn.addEventListener("click", () => {

        // ===== IMAGENS =====
        const fotosDiv = document.getElementById("det-fotos");
        fotosDiv.innerHTML = "";

        let imagens = [];

        try {
            imagens = JSON.parse(btn.dataset.imagens);
        } catch (e) {
            imagens = [];
        }

        if (imagens.length === 0) {
            fotosDiv.innerHTML = "<span style='color:#777'>Nenhuma foto enviada</span>";
        } else {
            imagens.forEach(url => {
                const img = document.createElement("img");
                img.src = url;
                img.alt = "Foto da manuten√ß√£o";
                fotosDiv.appendChild(img);
            });
        }

        // ===== DADOS =====
        document.getElementById("det-brinquedo").textContent = btn.dataset.brinquedo;
        document.getElementById("det-descricao").textContent = btn.dataset.descricao;

        const statusSpan = document.getElementById("det-status");
        statusSpan.textContent = btn.dataset.status;
        statusSpan.className = "status-badge status-" + btn.dataset.status.charAt(0);

        document.getElementById("det-endereco").textContent = btn.dataset.endereco;
        document.getElementById("det-bairro").textContent = btn.dataset.bairro;
        document.getElementById("det-cidade").textContent = btn.dataset.cidade;
        document.getElementById("det-estado").textContent = btn.dataset.estado;

        document.getElementById("cancelar-id").value = btn.dataset.id;

        // ===== WHATSAPP =====
        if (btn.dataset.telefone) {
            const telefone = btn.dataset.telefone.replace(/\D/g, "");
            const msg = encodeURIComponent("Ol√°! Gostaria de falar sobre minha manuten√ß√£o.");
            document.getElementById("btn-whatsapp").href =
                `https://wa.me/55${telefone}?text=${msg}`;
        }

        modalDetalhe.style.display = "block";
    });
});

// Fechar modal
closeDetalhe.addEventListener("click", () => {
    modalDetalhe.style.display = "none";
});

window.addEventListener("click", e => {
    if (e.target === modalDetalhe) {
        modalDetalhe.style.display = "none";
    }
});



document.addEventListener("DOMContentLoaded", () => {
    const telefoneInput = document.querySelector(".mask-telefone");
    if (!telefoneInput) return;

    telefoneInput.addEventListener("input", () => {
        telefoneInput.value = maskTelefoneBR(telefoneInput.value);
    });
});

function maskTelefoneBR(value) {
    value = value.replace(/\D/g, "");

    if (value.length > 11) {
        value = value.slice(0, 11);
    }

    if (value.length <= 10) {
        // Telefone fixo: (00) 0000-0000
        return value
            .replace(/^(\d{2})(\d)/, "($1) $2")
            .replace(/(\d{4})(\d)/, "$1-$2");
    }

    // Celular: (00) 00000-0000
    return value
        .replace(/^(\d{2})(\d)/, "($1) $2")
        .replace(/(\d{5})(\d)/, "$1-$2");
}




function mask(input, pattern) {
    if (!input) return;

    input.addEventListener("input", () => {
        let i = 0;
        const value = input.value.replace(/\D/g, "");
        input.value = pattern.replace(/#/g, () => value[i++] || "");
    });
}


document.addEventListener("DOMContentLoaded", () => {
    const cepInput = document.querySelector(".mask-cep");
    const feedback = document.getElementById("cepFeedback");

    if (!cepInput) return;

    mask(cepInput, "#####-###");

    let buscandoCep = false;

    cepInput.addEventListener("input", () => {
        const cep = cepInput.value.replace(/\D/g, "");

       if (cep.length < 8) {
        buscandoCep = false;
        bloquearEndereco();

        cepInput.classList.remove("campo-erro", "campo-loading");
        feedback.textContent = "";
        feedback.className = "cep-feedback";

        return;
    }

        if (buscandoCep) return;

    buscandoCep = true;

        // Estado: carregando
        cepInput.classList.remove("campo-erro");
        cepInput.classList.add("campo-loading");
        feedback.textContent = "Buscando CEP‚Ä¶";
        feedback.className = "cep-feedback cep-loading";

        fetch(`https://viacep.com.br/ws/${cep}/json/`)
            .then(res => res.json())
            .then(data => {
                buscandoCep = false;
                cepInput.classList.remove("campo-loading");

                if (data.erro) {
                    marcarErroCep("CEP n√£o encontrado");
                    return;
                }

                preencherEndereco(data);
                liberarEndereco();
                feedback.textContent = "Endere√ßo encontrado ‚úî";
                feedback.className = "cep-feedback cep-success";
            })
            .catch(() => {
                buscandoCep = false;
                cepInput.classList.remove("campo-loading");
                marcarErroCep("Erro ao consultar CEP");
            });
    });

    function marcarErroCep(msg) {
        bloquearEndereco();
        cepInput.classList.add("campo-erro");
        feedback.textContent = msg;
        feedback.className = "cep-feedback cep-error";
    }
});

function preencherEndereco(data) {
    document.querySelector("#id_endereco").value = data.logradouro || "";
    document.querySelector("#id_bairro").value = data.bairro || "";
    document.querySelector("#id_cidade").value = data.localidade || "";
    document.querySelector("#id_estado").value = data.uf || "";

    limparErroCep();
}

function limparErroCep() {
    const cepInput = document.querySelector(".mask-cep");
    cepInput.classList.remove("campo-erro");
}



document.getElementById("imagens").addEventListener("change", function() {
    const preview = document.getElementById("preview");
    preview.innerHTML = "";

    Array.from(this.files).forEach(file => {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.style.width = "80px";
        img.style.height = "80px";
        img.style.objectFit = "cover";
        img.style.borderRadius = "8px";
        preview.appendChild(img);
    });
});


const inputFotos = document.getElementById("imagens");
const uploadCard = document.getElementById("uploadCard");
const preview = document.getElementById("preview");
const uploadInfo = document.getElementById("uploadInfo");

let filesArray = [];
const MAX_FILES = 5;

uploadCard.addEventListener("click", () => inputFotos.click());

inputFotos.addEventListener("change", () => {
    const novosArquivos = Array.from(inputFotos.files);

    novosArquivos.forEach(file => {
        if (filesArray.length < MAX_FILES) {
            filesArray.push(file);
        }
    });

    if (filesArray.length > MAX_FILES) {
        filesArray = filesArray.slice(0, MAX_FILES);
        alert("Voc√™ pode enviar no m√°ximo 5 fotos.");
    }

    renderPreview();
});

function renderPreview() {
    preview.innerHTML = "";

    uploadInfo.textContent = `${filesArray.length} de ${MAX_FILES} fotos selecionadas`;

    filesArray.forEach((file, index) => {
        const div = document.createElement("div");
        div.className = "preview-item";

        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);

        const btn = document.createElement("button");
        btn.innerHTML = "√ó";
        btn.onclick = () => removerImagem(index);

        div.appendChild(img);
        div.appendChild(btn);
        preview.appendChild(div);
    });

    atualizarInput();
}

function removerImagem(index) {
    filesArray.splice(index, 1);
    renderPreview();
}

function atualizarInput() {
    const dt = new DataTransfer();
    filesArray.forEach(file => dt.items.add(file));
    inputFotos.files = dt.files;
}

const camposEndereco = [
    "#id_endereco",
    "#id_bairro",
    "#id_cidade",
    "#id_estado"
];

function bloquearEndereco() {
    camposEndereco.forEach(selector => {
        const campo = document.querySelector(selector);
        if (!campo) return;

        campo.value = "";
        campo.disabled = true;
        campo.classList.add("campo-bloqueado");
    });
}

function liberarEndereco() {
    camposEndereco.forEach(selector => {
        const campo = document.querySelector(selector);
        if (!campo) return;

        campo.disabled = false;
        campo.classList.remove("campo-bloqueado");
    });
}


</script>

{% endblock %}
