{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
/* ================= CARD ATIVO ================= */
.card-produto.ativo {
    border: 2px solid #004AAD;
    box-shadow: 0 12px 26px rgba(0, 74, 173, 0.35);
    transform: translateY(-6px);
}

.card-produto.ativo h3 {
    color: #004AAD;
}

/* ===== BREADCRUMB ===== */
.breadcrumb {
    max-width: 1200px;
    margin: 25px auto;
    font-size: 1rem;
}

.breadcrumb a {
    color: #004AAD;
    text-decoration: none;
    font-weight: 600;
}

.breadcrumb span {
    margin: 0 6px;
    color: #888;
}

/* ===== HEADER ===== */
.header-estabelecimento {
    text-align: center;
    margin-bottom: 30px;
}

.header-estabelecimento h1 {
    font-size: 2.4rem;
    color: #004AAD;
}

/* ===== FILTROS ===== */
.filtros-horizontal {
    max-width: 1200px;
    margin: 0 auto 30px;
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
}

.filtro-btn {
    padding: 8px 14px;
    border-radius: 20px;
    background: #eef2ff;
    color: #004AAD;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: .2s;
}

.filtro-btn:hover,
.filtro-btn.ativo {
    background: #004AAD;
    color: #fff;
}

/* ===== GRID ===== */
.grid-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 28px;
}

/* ===== CARD ===== */
.card-produto {
    background: #fff;
    border-radius: 14px;
    padding: 15px;
    box-shadow: 0 4px 10px rgba(0,0,0,.08);
    transition: .25s ease;
    cursor: pointer;
    display: flex;
    flex-direction: column;
}

.card-produto:hover {
    transform: translateY(-6px);
    box-shadow: 0 10px 22px rgba(0,0,0,.15);
}

/* ===== IMAGEM ===== */
.img-area {
    height: 180px;
    border-radius: 12px;
    overflow: hidden;
    background: #f2f4ff;
}

.img-area img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* ===== TEXTO ===== */
.card-produto h3 {
    margin-top: 14px;
    font-size: 1.2rem;
    color: #004AAD;
}

.descricao {
    font-size: .95rem;
    color: #555;
    margin: 6px 0 10px;
    flex-grow: 1;
}

.preco {
    font-size: 1.15rem;
    color: #00913f;
    font-weight: 700;
}

.star {
    color: #ccc;
}

.star.filled {
    color: #f5b301;
}

    .avaliacao {
    display: flex;
    gap: 3px;
    margin: 6px 0;
}

.star {
    font-size: 1.1rem;
    color: #ddd;
    position: relative;
}

.star.cheia {
    color: #f5b301;
}

.star.meia::before {
    content: "‚òÖ";
    position: absolute;
    left: 0;
    width: 50%;
    overflow: hidden;
    color: #f5b301;
}

.aviso-preco {
    font-family: 'Poppins', 'Segoe UI', sans-serif;
    font-size: 16px;
    font-weight: 500;
    color: #d97706; /* dourado elegante */
    background: #fff7ed;
    border-left: 4px solid #f59e0b;
    padding: 10px 14px;
    border-radius: 6px;
    margin-top: 8px;
}

</style>

<!-- üîµ BREADCRUMB -->
<nav class="breadcrumb">
    <a href="{% url 'home' %}">Home</a>
    <span>‚Ä∫</span>
    <a href="{% url 'estabelecimentos' %}#header">Estabelecimentos</a>
    <span>‚Ä∫</span>
    <strong> {{ estabelecimento.nome_estabelecimento }}</strong>
</nav>

<!-- üîµ HEADER -->
<div class="header-estabelecimento">
    <h1>Brinquedos recmendados para {{ estabelecimento.nome_estabelecimento }}</h1>
    <p>{{ brinquedos|length }} brinquedo(s) dispon√≠veis</p>
</div>

<!-- üîµ FILTROS -->
<div class="filtros-horizontal" id="filter">
    <button class="filtro-btn ativo" data-filtro="az">A‚ÄìZ</button>
    <button class="filtro-btn" data-filtro="za">Z‚ÄìA</button>
    <button class="filtro-btn" data-filtro="avaliacao">‚≠ê Melhores avaliados</button>
    <button class="filtro-btn" data-filtro="preco">üí∞ Menor pre√ßo</button>
</div>

<!-- üîµ LISTAGEM -->
{% if brinquedos %}
<div class="grid-cards" id="lista-brinquedos">

{% for item in brinquedos %}
<div class="card-produto"
     data-nome="{{ item.nome_brinquedo|lower }}"
     data-avaliacao="{{ item.avaliacao }}"
     data-preco="{{ item.valor_brinquedo }}"
     data-url="{% url 'brinquedo_detalhe' item.id %}#produto-box"
     id="estabelecimentos"   >

    <div class="img-area">
        {% if item.imagem_brinquedo %}
            <img src="{{ item.imagem_brinquedo.url }}">
        {% else %}
            <img src="{% static 'img/placeholder.png' %}">
        {% endif %}
    </div>

    <h3>{{ item.nome_brinquedo }}</h3>

   <div class="avaliacao" data-avaliacao="{{ item.avaliacao }}"></div>


    <p class="descricao">{{ item.descricao|truncatechars:90 }}</p>

    <!--
    <p class="preco money" data-valor="{{ item.valor_brinquedo }}">R$ 0,00</p>
    -->
    <p class="preco aviso-preco">
        Confira o pre√ßo com o fornecedor
    </p>
</div>
{% endfor %}

</div>
{% else %}
<p style="text-align:center">Nenhum brinquedo dispon√≠vel.</p>
{% endif %}

<script>
function formatarMoedaBR(valor) {
    if (valor === null || valor === undefined || valor === "" || valor === "None") {
        return "0,00";
    }

    const numero = Number(valor.toString().replace(",", "."));
    if (isNaN(numero)) return "0,00";

    return numero.toLocaleString("pt-BR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function aplicarMoeda() {
    document.querySelectorAll(".money").forEach(el => {
        el.textContent = "R$ " + formatarMoedaBR(el.dataset.valor);
    });
}

/* ================= FILTROS ================= */
function aplicarFiltro(tipo) {
    const container = document.getElementById("lista-brinquedos");
    const cards = Array.from(container.children);

    cards.sort((a, b) => {
        const nomeA = a.dataset.nome;
        const nomeB = b.dataset.nome;

        const avaliacaoA = parseFloat(a.dataset.avaliacao) || 0;
        const avaliacaoB = parseFloat(b.dataset.avaliacao) || 0;

        const precoA = parseFloat(a.dataset.preco) || 999999;
        const precoB = parseFloat(b.dataset.preco) || 999999;

        if (tipo === "az") return nomeA.localeCompare(nomeB);
        if (tipo === "za") return nomeB.localeCompare(nomeA);
        if (tipo === "avaliacao") return avaliacaoB - avaliacaoA;

        if (tipo === "preco") {
            const scoreA = avaliacaoA / precoA;
            const scoreB = avaliacaoB / precoB;
            return scoreB - scoreA;
        }
    });

    cards.forEach(card => container.appendChild(card));

    // ‚≠ê SEMPRE renderiza ap√≥s reordenar
    renderizarEstrelas();
}


function renderizarEstrelas() {
    document.querySelectorAll(".avaliacao").forEach(container => {
        const nota = parseFloat(container.dataset.avaliacao) || 0;
        container.innerHTML = "";

        const inteiras = Math.floor(nota);
        const temDecimal = nota % 1 !== 0;

        for (let i = 1; i <= 5; i++) {
            const star = document.createElement("span");
            star.classList.add("star");
            star.textContent = "‚òÖ";

            // estrela cheia apenas se for inteiro OU 5 exato
            if (i <= inteiras && (!temDecimal || nota === 5)) {
                star.classList.add("cheia");
            }
            // meia estrela somente na pr√≥xima posi√ß√£o
            else if (i === inteiras + 1 && temDecimal && nota < 5) {
                star.classList.add("meia");
            }

            container.appendChild(star);
        }
    });
}


/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", () => {
    aplicarMoeda();
    renderizarEstrelas(); // ‚≠ê inicial

    // filtros
    document.querySelectorAll(".filtro-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".filtro-btn").forEach(b => b.classList.remove("ativo"));
            btn.classList.add("ativo");
            aplicarFiltro(btn.dataset.filtro);
        });
    });

    // card ativo + redirect
    document.querySelectorAll(".card-produto").forEach(card => {
        card.addEventListener("click", () => {
            document.querySelectorAll(".card-produto").forEach(c => c.classList.remove("ativo"));
            card.classList.add("ativo");
            window.location.href = card.dataset.url;
        });
    });

    // filtro inicial
    aplicarFiltro("az");
});
</script>

{% endblock %}
