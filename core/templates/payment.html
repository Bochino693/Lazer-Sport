{% extends "base.html" %}
{% block content %}
{% load static %}


<style>
.payment-resumo-box {
    background: #fff;
    padding: 30px;
    border-radius: 18px;
    box-shadow: 0 10px 30px rgba(0,0,0,.08);
    text-align: center;
}

.valor-total {
    font-size: 2.6rem;
    font-weight: 800;
    color: #1e40af; /* azul do site */
    margin: 0;
}

.valor-legenda {
    color: #64748b;
    margin-bottom: 25px;
}

.resumo-itens {
    text-align: left;
    margin-top: 20px;
}

.resumo-item {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px dashed #e5e7eb;
}

.resumo-totais {
    margin-top: 20px;
    font-weight: 700;
}

.resumo-totais div {
    display: flex;
    justify-content: space-between;
}

.resumo-totais .desconto {
    color: #16a34a;
}


/* ===== BREADCRUMB STRONG ===== */
.breadcrumb-strong {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 18px;
    margin-bottom: 30px;

    background: linear-gradient(135deg, #f8fafc, #eef2ff);
    border-radius: 14px;

    font-size: 1.05rem;
    font-weight: 700;
    letter-spacing: .3px;

    box-shadow: 0 8px 20px rgba(0,0,0,.08);
}

/* Links */
.breadcrumb-strong a {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #1e3a8a;
    text-decoration: none;
    transition: all .2s ease;
}

.breadcrumb-strong a:hover {
    transform: translateY(-1px);
    color: #0d6efd;
}

/* Separador */
.breadcrumb-strong .sep {
    font-size: .85rem;
    color: #94a3b8;
}

/* P√°gina atual */
.breadcrumb-strong strong {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #111827;
}

/* √çcones */
.breadcrumb-strong i {
    font-size: 1rem;
}

/* ===== MOBILE ===== */
@media (max-width: 768px) {
    .breadcrumb-strong {
        font-size: .95rem;
        padding: 12px 14px;
        gap: 10px;
    }

    .breadcrumb-strong span {
        display: none; /* s√≥ √≠cones no mobile */
    }
}


    .payment-container {
    max-width: 700px;
    margin: 40px auto;
    padding: 20px;
}

.payment-header h1 {
    margin-bottom: 5px;
}

.payment-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin: 30px 0;
}

.payment-card {
    border: 2px solid #e5e7eb;
    padding: 18px;
    border-radius: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 1.05rem;
    transition: .25s ease;
    background: #fff;
}

.payment-card:hover {
    border-color: #4f46e5;
    transform: translateY(-2px);
}

.payment-card input {
    display: none;
}

.payment-card.active {
    border-color: #4f46e5;
    background: #eef2ff;
}

.payment-details {
    grid-column: 1 / -1; /* ocupa largura toda */
    margin-top: 10px;
}

.texto-destaque {
    text-align: center;           /* centraliza o texto */
    font-size: 1.5rem;            /* tamanho grande */
    font-weight: 700;             /* negrito */
    color: #1e40af;               /* azul destacado */
    margin: 30px auto;            /* espa√ßamento acima e abaixo, centralizado */
    padding: 15px 20px;           /* um pouco de espa√ßo interno */
    background: #f0f4ff;          /* leve fundo para destacar */
    border-radius: 12px;          /* cantos arredondados */
    box-shadow: 0 5px 15px rgba(0,0,0,0.1); /* sombra suave */
}


.payment-alert {
    background: #fff7ed;
    border: 1px solid #fed7aa;
    padding: 12px;
    border-radius: 10px;

    text-align: center;
    margin: 20px auto;
    font-size: 1.1rem;
    font-weight: 600;
}

.btn-confirmar {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    background: #4f46e5;
    color: white;
    border: none;
    font-size: 1rem;
}

/* ===== CART√ÉO BOX MODERNO ===== */
.card-box {
    margin-top: 20px;
    padding: 24px;
    border-radius: 18px;
    background: #ffffff;
    box-shadow: 0 20px 40px rgba(0,0,0,.08);
    animation: slideDown .35s ease;
}

/* anima√ß√£o */
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-8px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* inputs */
.input-group {
    margin-bottom: 16px;
}

.input-group label {
    display: block;
    font-size: .85rem;
    font-weight: 600;
    color: #475569;
    margin-bottom: 6px;
}

.input-group input {
    width: 100%;
    padding: 14px 14px;
    border-radius: 12px;
    border: 1.8px solid #e5e7eb;
    font-size: .95rem;
    transition: .2s;
}

.input-group input:focus {
    outline: none;
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79,70,229,.15);
}

/* √≠cone bandeira */
.input-icon {
    position: relative;
}

.bandeira {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    height: 24px;
    display: none;
}

/* grid validade + cvv */
.grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

/* tipo cart√£o */
#tipo-cartao {
    display: block;
    margin-top: 6px;
    font-size: .8rem;
    color: #64748b;
}

/* bot√£o */
.btn-cartao {
    margin-top: 20px;
    width: 100%;
    padding: 15px;
    border-radius: 14px;
    font-size: 1rem;
    font-weight: 700;
    background: linear-gradient(135deg, #1e40af, #3b82f6); /* gradiente azul do site */
    transition: transform .2s, box-shadow .2s;
}

.btn-cartao:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 25px rgba(79,70,229,.35);
}

    /* ===== CART√ÉO VISUAL ===== */
.cartao-visual {
    position: relative;
    width: 100%;
    height: 180px;
    border-radius: 18px;
    background: linear-gradient(135deg, #1e40af, #3b82f6); /* gradiente azul do site */
    color: #fff;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 15px 35px rgba(0,0,0,.2);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.cartao-bandeira img {
    height: 32px;
    position: absolute;
    top: 20px;
    right: 20px;
}

.cartao-numero {
    font-size: 1.3rem;
    letter-spacing: 2px;
    font-weight: 600;
}

.cartao-info {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
    font-weight: 500;
}

.btn-pix-copiar {
    width: 100%;
    max-width: 320px;
    padding: 15px 0;
    margin: 0 auto;
    display: block;

    background: linear-gradient(135deg, #2563eb, #1e40af);
    color: #fff;

    border: none;
    border-radius: 14px;

    font-size: 1.05rem;
    font-weight: 700;

    cursor: pointer;
    transition: all .25s ease;
}

.btn-pix-copiar:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 30px rgba(37,99,235,.35);
}

.btn-pix-confirmar {
    width: 100%;
    max-width: 320px;
    padding: 16px 0;
    margin: 18px auto 0;
    display: block;

    background: linear-gradient(135deg, #16a34a, #22c55e);
    color: #fff;

    border: none;
    border-radius: 14px;

    font-size: 1.1rem;
    font-weight: 800;

    cursor: pointer;
    transition: all .25s ease;

    animation: aparecer .35s ease;
}

.btn-pix-confirmar:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 30px rgba(22,163,74,.35);
}

@keyframes aparecer {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

</style>


<!-- ===== BREADCRUMB FORTE ===== -->
<nav class="breadcrumb-strong" id="bread">
    <a href="{% url 'home' %}">
        <i class="fa-solid fa-house"></i>
        <span>Home</span>
    </a>

    <i class="fa-solid fa-chevron-right sep"></i>

    <a href="{% url 'carrinho' %}">
        <i class="fa-solid fa-cart-shopping"></i>
        <span>Carrinho</span>
    </a>

    <i class="fa-solid fa-chevron-right sep"></i>

    <strong>
        <i class="fa-solid fa-credit-card"></i>
        Pagamento
    </strong>
</nav>


<section class="payment-container" id="content">

    <header class="payment-header">
        <h1>Pagamento</h1>
        <p>Escolha a forma de pagamento para concluir</p>
    </header>

    <div class="payment-resumo-box" id="roll">

    <h2 class="valor-total">
        R$ {{ total_liquido|floatformat:2 }}
    </h2>

    <p class="valor-legenda">Total a pagar</p>

    <div class="resumo-itens">
        {% for item in itens %}
            <div class="resumo-item">
                <span>{{ item.item }}</span>
                <span>{{ item.quantidade }} √ó</span>
                <strong class="money">
                    R$ {{ item.subtotal|floatformat:2 }}
                </strong>
            </div>
        {% endfor %}
    </div>

    <div class="resumo-totais">
        <div>
            <span>Subtotal</span>
            <span>R$ {{ total_bruto|floatformat:2 }}</span>
        </div>

        {% if valor_desconto > 0 %}
        <div class="desconto">
            <span>Desconto</span>
            <span>- R$ {{ valor_desconto|floatformat:2 }}</span>
        </div>
        {% endif %}
    </div>

</div>

    {% if carrinho_vazio %}
        <div class="texto-destaque">
        üßæ Seu carrinho est√° vazio.
        Pagamentos dispon√≠veis apenas via <strong>PIX</strong>.
    </div>
    {% else %}
        <div class="texto-destaque">
        <strong>{{ total_itens }}</strong> item(ns) no carrinho
    </div>
    {% endif %}

   <form method="post" class="payment-form">
    {% csrf_token %}

    <div class="payment-options">

        <!-- PIX -->
        <label class="payment-card active" data-target="pix-box">
            <input type="radio" name="metodo" value="pix" checked>
            ‚ö° PIX
        </label>

        <!-- CART√ÉO -->
        <label class="payment-card {% if somente_pix %}disabled{% endif %}"
               data-target="cartao-box">
            <input type="radio" name="metodo" value="cartao"
                   {% if somente_pix %}disabled{% endif %}>
            üí≥ Cart√£o
        </label>

        <!-- ===== PIX BOX ===== -->
<div id="pix-box" class="payment-details" style="text-align:center; padding:30px; border-radius:18px; background:#f8f9ff; box-shadow:0 10px 30px rgba(0,0,0,.08);">

    <div style="margin-bottom:25px">
        <img src="{% static 'images/img.png' %}"
             alt="QR Code PIX"
             width="220"
             style="border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,.1);">
    </div>

    <div style="margin-bottom:20px">
        <label style="font-weight:700; font-size:1.2rem; display:block; margin-bottom:8px;">
            PIX Copia e Cola
        </label>

        <input
            id="pix-code"
            type="text"
            readonly
            value="000201
26360014BR.GOV.BCB.PIX
0114+5511992211008
52040000
5303986
54{VALOR}
5802BR
5909LOJA TESTE
6009SAO PAULO
62070503***
6304"
            style="width:100%; padding:16px; font-size:1.1rem; border-radius:12px; border:2px solid #cbd5e1; text-align:center; font-weight:600; background:#fff;"
        >
    </div>

    <!-- BOT√ÉO COPIAR -->
<button
    type="button"
    class="btn-pix-copiar"
    onclick="copiarPix()">
    üìã Copiar PIX
</button>


</div>

<!-- ===== CART√ÉO BOX INTERATIVO ===== -->
<div id="cartao-box" class="payment-details card-box" style="display:none">

     <!-- visual do cart√£o -->
    <div class="cartao-visual">
        <div class="cartao-bandeira">
            <img id="bandeira-cartao" src="" alt="" style="display:none">
        </div>
        <div class="cartao-numero" id="cartao-numero-display">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
        <div class="cartao-info">
            <span id="cartao-nome-display">NOME DO TITULAR</span>
            <span id="cartao-validade-display">MM/AA</span>
        </div>
    </div>

    <!-- inputs -->
    <div class="input-group">
        <label>N√∫mero do cart√£o</label>
        <input type="text" id="numero-cartao" placeholder="0000 0000 0000 0000" maxlength="19">
        <small id="tipo-cartao"></small>
    </div>

    <div class="grid-2">
        <div class="input-group">
            <label>Validade</label>
            <input type="text" id="validade-cartao" placeholder="MM/AA" maxlength="5">
        </div>

        <div class="input-group">
            <label>CVV</label>
            <input type="text" id="cvv-cartao" placeholder="‚Ä¢‚Ä¢‚Ä¢" maxlength="3">
        </div>
    </div>

    <div class="input-group">
        <label>Nome no cart√£o</label>
        <input type="text" id="nome-cartao" placeholder="Nome completo">
    </div>

    <div class="input-group">
        <label>CPF do titular</label>
        <input type="text" id="cpf-cartao" placeholder="000.000.000-00" maxlength="14">
    </div>

    <button type="button" class="btn-confirmar btn-cartao" onclick="processarPagamento()">üí≥ Pagar com cart√£o</button>
</div>

<!-- Modal de espera -->
<div id="modal-aguarde" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:#fff; padding:20px; border-radius:8px; text-align:center;">
        ‚è≥ Processando pagamento...
    </div>
</div>

    </div>
   </form>
</section>

<script>


document.addEventListener('DOMContentLoaded', () => {

    // ===== ELEMENTOS =====
    const pixBox = document.getElementById('pix-box');
    const cartaoBox = document.getElementById('cartao-box');
    const cards = document.querySelectorAll('.payment-card');

    const numeroInput = document.getElementById('numero-cartao');
    const validadeInput = document.getElementById('validade-cartao');
    const nomeInput = document.getElementById('nome-cartao');

    const numeroDisplay = document.getElementById('cartao-numero-display');
    const validadeDisplay = document.getElementById('cartao-validade-display');
    const nomeDisplay = document.getElementById('cartao-nome-display');
    const bandeiraImg = document.getElementById('bandeira-cartao');
    const tipoCartao = document.getElementById('tipo-cartao');

    // ===== FUN√á√ÉO PARA MOSTRAR BOX CORRETO =====
    function mostrarMetodo(metodo) {
        pixBox.style.display = metodo === 'pix' ? 'block' : 'none';
        cartaoBox.style.display = metodo === 'cartao' ? 'block' : 'none';
    }

    // ===== FORMATA N√öMERO PARA BR =====
    function formatarNumeroBR(valor) {
        return Number(valor).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // ===== FORMATA TODOS OS VALORES DO RESUMO =====
    function formatarResumo() {
        const box = document.querySelector('.payment-resumo-box');
        if (!box) return;

        // Total
        const totalEl = box.querySelector('.valor-total');
        if (totalEl) {
            let numero = parseFloat(totalEl.textContent.replace(/\./g, '').replace(',', '.').replace(/[^\d.-]/g, ''));
            if (!isNaN(numero)) totalEl.textContent = 'R$ ' + formatarNumeroBR(numero);
        }

        // Subtotal e desconto
        const totaisEl = box.querySelectorAll('.resumo-totais div span:last-child');
        totaisEl.forEach(el => {
            let texto = el.textContent.replace(/\./g, '').replace(',', '.').replace(/[^\d.-]/g, '');
            let numero = parseFloat(texto);
            if (!isNaN(numero)) el.textContent = (numero < 0 ? '-' : '') + 'R$ ' + formatarNumeroBR(Math.abs(numero));
        });

        // Pre√ßo unit√°rio e subtotal dos itens
        const itensEl = box.querySelectorAll('.resumo-item strong');
        itensEl.forEach(el => {
            let texto = el.textContent.replace(/\./g, '').replace(',', '.').replace(/[^\d.-]/g, '');
            let numero = parseFloat(texto);
            if (!isNaN(numero)) el.textContent = 'R$ ' + formatarNumeroBR(numero);
        });
    }

    // ===== FORMATA VALOR TOTAL PERSONALIZADO =====
    function formatarValorTotal() {
        const el = document.getElementById('valor-total-box');
        if (!el) return;

        let texto = el.textContent.replace(/\./g, '').replace(',', '.').replace(/[^\d.-]/g, '');
        let numero = parseFloat(texto);
        if (!isNaN(numero)) {
            el.innerHTML = `Valor: <span style="color:#2563eb;">R$ ${formatarNumeroBR(numero)}</span>`;
        }
    }

    formatarValorTotal();
    formatarResumo(); // chama imediatamente

    // ===== CLIQUE NOS CARDS =====
    cards.forEach(card => {
        card.addEventListener('click', () => {
            if (card.classList.contains('disabled')) return;

            cards.forEach(c => c.classList.remove('active'));
            card.classList.add('active');

            const radio = card.querySelector('input[type="radio"]');
            radio.checked = true;

            mostrarMetodo(radio.value);
        });
    });

    mostrarMetodo('pix'); // abre PIX por padr√£o

    // ===== CART√ÉO: M√ÅSCARA + ATUALIZA√á√ÉO VISUAL =====
    function detectarTipo(numero) {
        if (!numero) return '';
        if (/^4/.test(numero)) return 'Visa ‚Ä¢ Cr√©dito';
        if (/^5[1-5]/.test(numero)) return 'Mastercard ‚Ä¢ Cr√©dito';
        if (/^6/.test(numero)) return 'D√©bito';
        return 'Cart√£o';
    }

    function mascaraNumeroCartao(valor) {
        valor = valor.replace(/\D/g, '').substring(0, 16);
        return valor.replace(/(.{4})/g, '$1 ').trim();
    }

    function mascaraValidade(valor) {
        valor = valor.replace(/\D/g, '').substring(0, 4);
        if (valor.length > 2) valor = valor.substring(0, 2) + '/' + valor.substring(2);
        return valor;
    }

    function atualizarCartao() {
        let numero = numeroInput.value.replace(/\D/g, '').padEnd(16, '‚Ä¢');
        numero = numero.match(/.{1,4}/g)?.join(' ') || numero;
        numeroDisplay.textContent = numero;

        if (/^4/.test(numero)) {
            bandeiraImg.src = "{% static 'images/visa.png' %}";
            bandeiraImg.style.display = 'block';
        } else if (/^5[1-5]/.test(numero)) {
            bandeiraImg.src = "{% static 'images/mastercard.png' %}";
            bandeiraImg.style.display = 'block';
        } else if (/^6/.test(numero)) {
            bandeiraImg.src = "{% static 'images/elo.png' %}";
            bandeiraImg.style.display = 'block';
        } else {
            bandeiraImg.style.display = 'none';
        }

        tipoCartao.textContent = detectarTipo(numero.replace(/\s/g, ''));
        validadeDisplay.textContent = validadeInput.value || 'MM/AA';
        nomeDisplay.textContent = nomeInput.value || 'NOME DO TITULAR';
    }

    numeroInput.addEventListener('input', () => {
        numeroInput.value = mascaraNumeroCartao(numeroInput.value);
        atualizarCartao();
    });
    validadeInput.addEventListener('input', () => {
        validadeInput.value = mascaraValidade(validadeInput.value);
        atualizarCartao();
    });
    nomeInput.addEventListener('input', atualizarCartao);


    /* ===== COPIAR PIX ===== */
    function copiarPix() {
        const pixInput = document.getElementById('pix-code');

        navigator.clipboard.writeText(pixInput.value).then(() => {
            mostrarToast("PIX copiado com sucesso ‚úÖ");

        });
    }


    function mostrarToast(texto) {
        const toast = document.createElement('div');
        toast.innerText = texto;

        Object.assign(toast.style, {
            position: 'fixed',
            bottom: '30px',
            left: '50%',
            transform: 'translateX(-50%)',
            background: '#16a34a',
            color: '#fff',
            padding: '14px 22px',
            borderRadius: '12px',
            fontWeight: '700',
            boxShadow: '0 10px 25px rgba(0,0,0,.25)',
            zIndex: 99999
        });

        document.body.appendChild(toast);

        setTimeout(() => toast.remove(), 2500);
    }


    async function processarPagamento() {
        const numero = document.getElementById("numero-cartao").value;
        const validade = document.getElementById("validade-cartao").value;
        const cvv = document.getElementById("cvv-cartao").value;
        const nome = document.getElementById("nome-cartao").value;
        const cpf = document.getElementById("cpf-cartao").value;

        // abre modal
        document.getElementById("modal-aguarde").style.display = "flex";

        try {
            const response = await fetch("/processar_cartao/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({numero, validade, cvv, nome, cpf})
            });

            const data = await response.json();
            document.getElementById("modal-aguarde").style.display = "none";

            if (data.sucesso) {
                // redireciona para p√°gina final de pagamento
                window.location.href = `/payment_finally/${data.pedido_id}/`;
            } else {
                alert("Erro: " + data.mensagem);
            }
        } catch (e) {
            document.getElementById("modal-aguarde").style.display = "none";
            alert("Erro inesperado ao processar pagamento.");
        }
    }


    document.addEventListener("DOMContentLoaded", () => {
        if (window.location.hash) {
            const el = document.querySelector(window.location.hash);
            if (el) {
                setTimeout(() => {
                    el.scrollIntoView({behavior: "smooth", block: "start"});
                }, 100);
            }
        }
    });

    function iniciarVerificacaoPagamento() {
        const pedidoId = "{{ carrinho.id }}";

        const intervalo = setInterval(async () => {
            try {
                const res = await fetch(`/api/verificar-pagamento/${pedidoId}/`);
                const data = await res.json();

                if (data.pago) {
                    clearInterval(intervalo);

                    // üî• redireciona autom√°tico
                    window.location.href = "/pedidos/#pedidos";
                }
            } catch (e) {
                console.error("Erro ao verificar pagamento:", e);
            }
        }, 5000); // verifica a cada 5s
    }


async function carregarPix() {
    try {
        const valor = "{{ total_liquido|floatformat:2 }}";

        const res = await fetch(`/api/gerar-pix/?valor=${valor}`);
        const data = await res.json();

        if (data.erro) {
            console.error("Erro MP:", data.erro);
            return;
        }

        // QR code
        document.querySelector("#pix-box img").src =
            "data:image/png;base64," + data.qr_code;

        // copia e cola
        document.getElementById("pix-code").value = data.pix_copia_cola;

        iniciarVerificacaoPagamento();

    } catch (e) {
        console.error("Erro ao carregar PIX:", e);
    }
}


</script>


{% endblock %}
